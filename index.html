<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</title>
  <style>
    :root {
      --primary: #007bff;
      --danger: #dc3545;
      --border: #ddd;
      --bg: #fff;
      --text: #333;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 8px 16px;
      background: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .tab-btn.active {
      background: var(--primary);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .header-info {
      margin-bottom: 20px;
      padding: 12px;
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 12px 0;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #444;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
    }

    h3 {
      text-align: center;
      margin: 20px 0 12px;
      color: var(--text);
      font-size: 18px;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 6px;
      border: 1px solid var(--border);
    }
    thead th {
      font-weight: 600;
      background: #f8f9fa;
    }

    .btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      margin: 5px;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn-danger { background: var(--danger); }
    .no-print { display: none; }

    @media print {
      .no-print { display: block; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; border: none; }
    }

    #auth-dialog {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .auth-form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .auth-form h3 {
      margin-top: 0;
    }
    .auth-form input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .auth-form .btn {
      width: 100%;
      margin: 10px 0 5px;
    }
    .auth-info {
      font-size: 12px;
      margin-top: 10px;
      color: #666;
      line-height: 1.4;
    }
  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div id="auth-dialog">
  <div class="auth-form">
    <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" required />
    <button class="btn" id="login-btn" onclick="login()">–í–æ–π—Ç–∏</button>
    <p class="auth-info">
      üí° –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç.<br>
      ‚ö†Ô∏è –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
    </p>
  </div>
</div>

<div class="container">
  <div id="auth-ui" style="position: fixed; top: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; z-index: 999;">
    <div id="user-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button id="logout-btn" class="btn-sm" style="display:none;" onclick="logout()">–í—ã—Ö–æ–¥</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('form')">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
    <button class="tab-btn" onclick="switchTab('archive')">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
  </div>

  <div id="form-tab" class="tab-content active">
    <input type="hidden" id="claim-id">
    <div class="header-info">
      <strong>–ü–û–°–¢–ê–í–©–ò–ö:</strong> –û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é "–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û"<br>
      –ò–ù–ù 7723905004, –ö–ü–ü 772101001, –ö–æ–¥ –ø–æ –û–ö–ü–û 29289257<br>
      111674, –≥. –ú–æ—Å–∫–≤–∞, –≤–Ω.—Ç–µ—Ä.–≥. –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥ –ù–µ–∫—Ä–∞—Å–æ–≤–∫–∞, –ø—Ä-–∫—Ç –ó–∞—â–∏—Ç–Ω–∏–∫–æ–≤ –ú–æ—Å–∫–≤—ã<br>
      —Ç–µ–ª.: +7 999 599 00 03
    </div>

    <h3>–ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê</h3>

    <div class="form-row">
      <div class="form-group">
        <label>–ì–æ—Å–Ω–æ–º–µ—Ä *</label>
        <input type="text" id="car-number" placeholder="–ê123–ë–í77" oninput="lookupVehicle(this.value)">
      </div>
      <div class="form-group">
        <label>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏</label>
        <input type="text" id="claim-number" readonly>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ *</label>
        <input type="text" id="client-fio" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò." required>
      </div>
      <div class="form-group">
        <label>–ö–æ–º–ø–∞–Ω–∏—è (–æ–ø—Ü.)</label>
        <input type="text" id="client-company" placeholder="–û–û–û –¢—Ä–∞–Ω—Å">
      </div>
      <div class="form-group">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
        <input type="tel" id="phone" placeholder="+7 (___) ___-__-__" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ú–∞—Ä–∫–∞ *</label>
        <select id="car-brand" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
          <option value="–ì–ê–ó–µ–ª—å Next">–ì–ê–ó–µ–ª—å Next</option>
          <option value="Ford Transit">Ford Transit</option>
          <option value="Hyundai HD78">Hyundai HD78</option>
          <option value="Peugeot Boxer">Peugeot Boxer</option>
        </select>
      </div>
      <div class="form-group">
        <label>–ú–æ–¥–µ–ª—å *</label>
        <input type="text" id="car-model" placeholder="HD78" required>
      </div>
      <div class="form-group">
        <label>VIN</label>
        <input type="text" id="vin" placeholder="X12345678901234567">
      </div>
    </div>

    <div class="form-group">
      <label>–ñ–∞–ª–æ–±–∞ –∫–ª–∏–µ–Ω—Ç–∞ *</label>
      <textarea id="complaint" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..." oninput="suggestTemplate(this.value)" required></textarea>
    </div>

    <div id="template-suggestion" style="margin:10px 0; padding:10px; background:#e9ecef; border-radius:4px; display:none;">
      <strong>–ù–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω:</strong> <span id="template-title"></span>
      <button class="btn-sm" onclick="applyTemplate()">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ —à–∞–±–ª–æ–Ω—É</button>
    </div>

    <h3>–†–∞–±–æ—Ç—ã</h3>
    <table id="works-table">
      <thead>
        <tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–°—Ç–æ—Ä–æ–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–ù/—á</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th><th></th></tr>
      </thead>
      <tbody id="works-body"></tbody>
    </table>
    <button class="btn btn-sm" onclick="addWorkRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>

    <h3>–ó–∞–ø—á–∞—Å—Ç–∏</h3>
    <table id="parts-table">
      <thead>
        <tr><th>–ê—Ä—Ç.</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–°—Ç–æ—Ä–æ–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th><th></th></tr>
      </thead>
      <tbody id="parts-body"></tbody>
    </table>
    <button class="btn btn-sm" onclick="addPartRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</button>

    <div style="margin-top:10px; text-align:right;">
      <strong>–ò—Ç–æ–≥–æ: <span id="total-sum">0.00</span> ‚ÇΩ</strong>
    </div>

    <div class="no-print" style="margin-top:15px;">
      <button class="btn" onclick="saveAsDraft()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>
      <button class="btn" style="background:#28a745;" onclick="agreeClaim()">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ ‚Üí CSV –¥–ª—è 1–°</button>
      <button class="btn" onclick="printClaim()">–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∑–∞—è–≤–∫—É</button>
    </div>
  </div>

  <div id="archive-tab" class="tab-content">
    <h2>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
    <div id="archive-list"></div>
  </div>
</div>

<script>
  // ========== SUPABASE ==========
  const supabaseUrl = 'https://xvvhranmftqqddbplypu.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dmhyYW5tZnRxcWRkYnBseXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Nzk2OTgsImV4cCI6MjA4MTM1NTY5OH0.nAkRjSi5lHIvGwWCfi7GI48A_XRMEtSMKuJS6V3zgi4';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

  // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï ==========
  let currentUser = null;
  let currentTemplate = null;
  let workIndex = 1, partIndex = 1;

  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
  document.addEventListener('DOMContentLoaded', () => {
    generateClaimNumber();
    
    supabase.auth.getSession().then(({ data }) => {
      if (data.session?.user) {
        currentUser = data.session.user;
        document.getElementById('user-status').textContent = `üë§ ${currentUser.email}`;
        document.getElementById('logout-btn').style.display = 'inline-block';
        document.getElementById('auth-dialog').style.display = 'none';
        renderArchive();
      } else {
        document.getElementById('auth-dialog').style.display = 'flex';
        document.getElementById('user-status').textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
      }
    });
  });

  function generateClaimNumber() {
    const now = new Date();
    document.getElementById('claim-number').value = `SR-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`;
  }

  // ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –° –ê–í–¢–û-–†–ï–ì–ò–°–¢–†–ê–¶–ò–ï–ô ==========
  async function login() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const btn = document.getElementById('login-btn');

    if (!email || !password) {
      alert('‚ùå –í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
      return;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
      return;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è Supabase)
    if (password.length < 6) {
      alert('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
      return;
    }

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    btn.disabled = true;
    btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

    try {
      // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞
      let { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({ 
        email, 
        password 
      });

      if (signInError) {
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Invalid login credentials" - –ø—Ä–æ–±—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        if (signInError.message.includes('Invalid login') || signInError.message.includes('credentials')) {
          console.log('–ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', email);
          
          const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
            email,
            password,
            options: {
              emailRedirectTo: window.location.origin,
              data: {
                full_name: email.split('@')[0]
              }
            }
          });

          if (signUpError) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', signUpError);
            alert(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${signUpError.message}\n\n–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n- Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è\n- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\n- –ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ Supabase\n\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.`);
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
          if (signUpData.user && !signUpData.session) {
            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n\n‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.\n–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.');
            return;
          }

          if (signUpData.user && signUpData.session) {
            currentUser = signUpData.user;
            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
          }
        } else {
          alert(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${signInError.message}`);
          return;
        }
      } else {
        currentUser = signInData.user;
        console.log('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ:', currentUser.email);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      document.getElementById('auth-dialog').style.display = 'none';
      document.getElementById('user-status').textContent = `üë§ ${currentUser.email}`;
      document.getElementById('logout-btn').style.display = 'inline-block';
      renderArchive();
    } catch (err) {
      console.error('–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
      alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    } finally {
      btn.disabled = false;
      btn.textContent = '–í–æ–π—Ç–∏';
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    window.location.reload();
  }

  // ========== –ü–û–ò–°–ö –ê–í–¢–û ==========
  async function lookupVehicle(carNumber) {
    if (!carNumber.trim()) return;
    const upperNumber = carNumber.toUpperCase();
    document.getElementById('car-number').value = upperNumber;

    const { data, error } = await supabase
      .from('vehicles')
      .select('*')
      .eq('car_number', upperNumber)
      .single();

    if (data) {
      document.getElementById('client-fio').value = data.client_fio || '';
      document.getElementById('client-company').value = data.client_company || '';
      document.getElementById('phone').value = data.phone || '';
      document.getElementById('car-brand').value = data.car_brand || '';
      document.getElementById('car-model').value = data.car_model || '';
      document.getElementById('vin').value = data.vin || '';
    }
  }

  // ========== –®–ê–ë–õ–û–ù–´ ==========
  async function suggestTemplate(complaint) {
    if (!complaint.trim()) {
      document.getElementById('template-suggestion').style.display = 'none';
      return;
    }
    
    const { data } = await supabase.from('templates').select('*');
    let matched = null;
    
    for (const t of data || []) {
      if (t.keywords && Array.isArray(t.keywords)) {
        if (t.keywords.some(kw => complaint.toLowerCase().includes(kw.toLowerCase()))) {
          matched = t;
          break;
        }
      }
    }
    
    const el = document.getElementById('template-suggestion');
    if (matched) {
      currentTemplate = matched;
      document.getElementById('template-title').textContent = matched.title;
      el.style.display = 'block';
    } else {
      el.style.display = 'none';
      currentTemplate = null;
    }
  }

  function applyTemplate() {
    if (!currentTemplate) return;
    document.getElementById('works-body').innerHTML = '';
    document.getElementById('parts-body').innerHTML = '';
    workIndex = 1; partIndex = 1;

    if (currentTemplate.works) {
      try {
        const works = typeof currentTemplate.works === 'string' ? JSON.parse(currentTemplate.works) : currentTemplate.works;
        works.forEach(w => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><input type="text" value="${w.name || ''}"></td>
            <td><input type="text" value="${w.side || ''}"></td>
            <td><input type="number" value="${w.qty || 1}" min="1" oninput="calculateSums()"></td>
            <td><input type="number" value="${w.hours || 0}" step="0.1" oninput="calculateSums()"></td>
            <td><input type="number" value="${w.price || 0}" oninput="calculateSums()"></td>
            <td class="sum-cell">0.00</td>
            <td><button class="btn-sm btn-danger" onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
          document.getElementById('works-body').appendChild(row);
          workIndex++;
        });
      } catch (e) { console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç:', e); }
    }

    if (currentTemplate.parts) {
      try {
        const parts = typeof currentTemplate.parts === 'string' ? JSON.parse(currentTemplate.parts) : currentTemplate.parts;
        parts.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><input type="text" value="${p.article || ''}"></td>
            <td><input type="text" value="${p.name || ''}"></td>
            <td><input type="text" value="${p.side || ''}"></td>
            <td><input type="number" value="${p.qty || 1}" min="1" oninput="calculateSums()"></td>
            <td><input type="number" value="${p.price || 0}" oninput="calculateSums()"></td>
            <td class="sum-cell">0.00</td>
            <td><button class="btn-sm btn-danger" onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
          document.getElementById('parts-body').appendChild(row);
          partIndex++;
        });
      } catch (e) { console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π:', e); }
    }
    calculateSums();
    document.getElementById('template-suggestion').style.display = 'none';
  }

  // ========== –¢–ê–ë–õ–ò–¶–´ ==========
  function addWorkRow() {
    const tbody = document.getElementById('works-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" placeholder="–†–∞–±–æ—Ç–∞"></td>
      <td><input type="text" placeholder="–°—Ç–æ—Ä–æ–Ω–∞"></td>
      <td><input type="number" value="1" min="1" oninput="calculateSums()"></td>
      <td><input type="number" value="0" step="0.1" oninput="calculateSums()"></td>
      <td><input type="number" value="0" oninput="calculateSums()"></td>
      <td class="sum-cell">0.00</td>
      <td><button class="btn-sm btn-danger" onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
    tbody.appendChild(row); 
    workIndex++;
  }

  function addPartRow() {
    const tbody = document.getElementById('parts-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" placeholder="–ê—Ä—Ç–∏–∫—É–ª"></td>
      <td><input type="text" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"></td>
      <td><input type="text" placeholder="–°—Ç–æ—Ä–æ–Ω–∞"></td>
      <td><input type="number" value="1" min="1" oninput="calculateSums()"></td>
      <td><input type="number" value="0" oninput="calculateSums()"></td>
      <td class="sum-cell">0.00</td>
      <td><button class="btn-sm btn-danger" onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
    tbody.appendChild(row); 
    partIndex++;
  }

  function deleteRow(btn) { 
    btn.closest('tr').remove(); 
    calculateSums(); 
  }

  function calculateSums() {
    let total = 0;
    
    Array.from(document.querySelectorAll('#works-body tr')).forEach(row => {
      const inputs = row.querySelectorAll('input');
      const qty = parseFloat(inputs[2]?.value) || 0;
      const price = parseFloat(inputs[4]?.value) || 0;
      const sum = qty * price;
      row.querySelector('.sum-cell').textContent = sum.toFixed(2);
      total += sum;
    });
    
    Array.from(document.querySelectorAll('#parts-body tr')).forEach(row => {
      const inputs = row.querySelectorAll('input');
      const qty = parseFloat(inputs[3]?.value) || 0;
      const price = parseFloat(inputs[4]?.value) || 0;
      const sum = qty * price;
      row.querySelector('.sum-cell').textContent = sum.toFixed(2);
      total += sum;
    });
    
    document.getElementById('total-sum').textContent = total.toFixed(2);
  }

  // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
  function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById(`${tab}-tab`).classList.add('active');
    document.querySelector(`.tab-btn:nth-child(${tab === 'form' ? 1 : 2})`).classList.add('active');
    if (tab === 'archive') renderArchive();
  }

  // ========== –ê–†–•–ò–í ==========
  async function renderArchive() {
    if (!currentUser) return;
    
    const { data, error } = await supabase
      .from('claims')
      .select('*')
      .eq('master_id', currentUser.id)
      .order('created_at', { ascending: false });

    const el = document.getElementById('archive-list');
    
    if (error) {
      el.innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>`;
      return;
    }
    
    el.innerHTML = (data?.length ? data.map(c => `
      <div style="padding:12px;border:1px solid #ddd;margin:8px 0;border-radius:6px;background:#fafafa;">
        <strong>‚Ññ${c.number}</strong> ‚Äî ${c.client_fio} (${c.car_number})<br>
        <small>–î–∞—Ç–∞: ${new Date(c.created_at).toLocaleString('ru-RU')}</small><br>
        –°—Ç–∞—Ç—É—Å: ${c.status === 'agreed' ? '‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ' : 'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫'}<br>
        <button class="btn-sm" onclick="loadClaim('${c.id}')">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>`).join('') : '<p>–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</p>');
  }

  async function loadClaim(id) {
    const { data, error } = await supabase.from('claims').select('*').eq('id', id).single();
    if (error || !data) {
      alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–∫–∏');
      return;
    }

    document.getElementById('claim-id').value = data.id;
    document.getElementById('claim-number').value = data.number;
    document.getElementById('car-number').value = data.car_number;
    document.getElementById('client-fio').value = data.client_fio;
    document.getElementById('client-company').value = data.client_company || '';
    document.getElementById('phone').value = data.phone;
    document.getElementById('car-brand').value = data.car_brand;
    document.getElementById('car-model').value = data.car_model;
    document.getElementById('vin').value = data.vin || '';
    document.getElementById('complaint').value = data.complaint;

    document.getElementById('works-body').innerHTML = '';
    document.getElementById('parts-body').innerHTML = '';
    workIndex = 1; partIndex = 1;

    const { data: works } = await supabase.from('works').select('*').eq('claim_id', id);
    works?.forEach(w => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" value="${w.name}"></td>
        <td><input type="text" value="${w.side || ''}"></td>
        <td><input type="number" value="${w.qty}" min="1" oninput="calculateSums()"></td>
        <td><input type="number" value="${w.hours || 0}" step="0.1" oninput="calculateSums()"></td>
        <td><input type="number" value="${w.price}" oninput="calculateSums()"></td>
        <td class="sum-cell">${w.sum?.toFixed(2) || '0.00'}</td>
        <td><button class="btn-sm btn-danger" onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
      document.getElementById('works-body').appendChild(row);
      workIndex++;
    });

    const { data: parts } = await supabase.from('parts').select('*').eq('claim_id', id);
    parts?.forEach(p => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" value="${p.article || ''}"></td>
        <td><input type="text" value="${p.name}"></td>
        <td><input type="text" value="${p.side || ''}"></td>
        <td><input type="number" value="${p.qty}" min="1" oninput="calculateSums()"></td>
        <td><input type="number" value="${p.price}" oninput="calculateSums()"></td>
        <td class="sum-cell">${p.sum?.toFixed(2) || '0.00'}</td>
        <td><button class="btn-sm btn-danger" onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
      document.getElementById('parts-body').appendChild(row);
      partIndex++;
    });

    calculateSums();
    switchTab('form');
  }

  // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï ==========
  async function saveAsDraft() {
    if (!validateForm()) return;
    const data = collectClaimData('draft');
    const id = document.getElementById('claim-id').value;
    
    let claimId;
    if (id) {
      const { error } = await supabase.from('claims').update(data).eq('id', id);
      if (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
        return;
      }
      claimId = id;
    } else {
      const { data: newClaim, error } = await supabase.from('claims').insert(data).select('id').single();
      if (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
        return;
      }
      claimId = newClaim.id;
    }
    
    await saveWorksParts(claimId);
    alert('‚úÖ –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
    resetForm();
  }

  async function agreeClaim() {
    if (!validateForm()) return;
    const data = collectClaimData('agreed');
    const id = document.getElementById('claim-id').value;
    
    let claimId;
    if (id) {
      const { error } = await supabase.from('claims').update(data).eq('id', id);
      if (error) { 
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message); 
        return; 
      }
      claimId = id;
    } else {
      const { data: newClaim, error } = await supabase.from('claims').insert(data).select('id').single();
      if (error) { 
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message); 
        return; 
      }
      claimId = newClaim.id;
    }
    
    await saveWorksParts(claimId);
    generateCSV(claimId);
    alert('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞! CSV —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω.');
    resetForm();
  }

  function collectClaimData(status) {
    return {
      number: document.getElementById('claim-number').value,
      status,
      client_fio: document.getElementById('client-fio').value,
      client_company: document.getElementById('client-company').value || null,
      phone: document.getElementById('phone').value,
      car_number: document.getElementById('car-number').value,
      car_brand: document.getElementById('car-brand').value,
      car_model: document.getElementById('car-model').value,
      vin: document.getElementById('vin').value || null,
      complaint: document.getElementById('complaint').value,
      master_id: currentUser.id
    };
  }

  async function saveWorksParts(claimId) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
    await supabase.from('works').delete().eq('claim_id', claimId);
    await supabase.from('parts').delete().eq('claim_id', claimId);
    
    const worksData = [];
    Array.from(document.querySelectorAll('#works-body tr')).forEach(row => {
      const inputs = row.querySelectorAll('input');
      const qty = parseInt(inputs[2].value) || 1;
      const price = parseFloat(inputs[4].value) || 0;
      worksData.push({
        claim_id: claimId,
        name: inputs[0].value,
        side: inputs[1].value || null,
        qty: qty,
        hours: parseFloat(inputs[3].value) || 0,
        price: price,
        sum: qty * price
      });
    });
    
    const partsData = [];
    Array.from(document.querySelectorAll('#parts-body tr')).forEach(row => {
      const inputs = row.querySelectorAll('input');
      const qty = parseInt(inputs[3].value) || 1;
      const price = parseFloat(inputs[4].value) || 0;
      partsData.push({
        claim_id: claimId,
        article: inputs[0].value || null,
        name: inputs[1].value,
        side: inputs[2].value || null,
        qty: qty,
        price: price,
        sum: qty * price
      });
    });
    
    if (worksData.length) await supabase.from('works').insert(worksData);
    if (partsData.length) await supabase.from('parts').insert(partsData);
  }

  function validateForm() {
    const required = ['client-fio', 'phone', 'car-brand', 'car-model', 'car-number', 'complaint'];
    for (const id of required) {
      if (!document.getElementById(id).value.trim()) {
        alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–æ—Ç–º–µ—á–µ–Ω—ã *)');
        document.getElementById(id).focus();
        return false;
      }
    }
    return true;
  }

  function resetForm() {
    document.getElementById('claim-id').value = '';
    generateClaimNumber();
    document.getElementById('car-number').value = '';
    document.getElementById('client-fio').value = '';
    document.getElementById('client-company').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('car-brand').value = '';
    document.getElementById('car-model').value = '';
    document.getElementById('vin').value = '';
    document.getElementById('complaint').value = '';
    document.getElementById('works-body').innerHTML = '';
    document.getElementById('parts-body').innerHTML = '';
    workIndex = 1; partIndex = 1;
    document.getElementById('total-sum').textContent = '0.00';
    document.getElementById('template-suggestion').style.display = 'none';
  }

  // ========== –≠–ö–°–ü–û–†–¢ ==========
  function generateCSV(claimId) {
    let csv = '–ù–æ–º–µ—Ä_–∑–∞—è–≤–∫–∏,–î–∞—Ç–∞,–ö–æ–º–ø–∞–Ω–∏—è,–§–ò–û,–¢–µ–ª–µ—Ñ–æ–Ω,–†–æ–ª—å,–ú–∞—Ä–∫–∞,–ú–æ–¥–µ–ª—å,–ì–æ—Å–Ω–æ–º–µ—Ä,VIN,–¢–∏–ø_—Å—Ç—Ä–æ–∫–∏,–ê—Ä—Ç–∏–∫—É–ª,–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ,–°—Ç–æ—Ä–æ–Ω–∞,–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ,–ù–æ—Ä–º–æ—á–∞—Å—ã,–¶–µ–Ω–∞,–°—É–º–º–∞\n';
    
    const claimNumber = document.getElementById('claim-number').value;
    const date = new Date().toISOString().split('T')[0];
    const company = document.getElementById('client-company').value || '';
    const fio = document.getElementById('client-fio').value;
    const phone = document.getElementById('phone').value;
    const role = company ? '–ö–æ–º–ø–∞–Ω–∏—è' : '–§–∏–∑–ª–∏—Ü–æ';
    const brand = document.getElementById('car-brand').value;
    const model = document.getElementById('car-model').value;
    const number = document.getElementById('car-number').value;
    const vin = document.getElementById('vin').value || '';

    Array.from(document.querySelectorAll('#works-body tr')).forEach(row => {
      const inputs = row.querySelectorAll('input');
      const cols = [
        claimNumber, date, company, fio, phone, role, brand, model, number, vin,
        '–†–∞–±–æ—Ç–∞', '', inputs[0].value, inputs[1].value, inputs[2].value, 
        inputs[3].value, inputs[4].value, row.querySelector('.sum-cell').textContent
      ];
      csv += cols.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',') + '\n';
    });

    Array.from(document.querySelectorAll('#parts-body tr')).forEach(row => {
      const inputs = row.querySelectorAll('input');
      const cols = [
        claimNumber, date, company, fio, phone, role, brand, model, number, vin,
        '–ó–∞–ø—á–∞—Å—Ç—å', inputs[0].value, inputs[1].value, inputs[2].value, 
        inputs[3].value, '', inputs[4].value, row.querySelector('.sum-cell').textContent
      ];
      csv += cols.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',') + '\n';
    });

    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `–∑–∞—è–≤–∫–∞-${claimNumber}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function printClaim() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(16);
    doc.text('–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª', 14, 20);
    doc.setFontSize(12);
    doc.text(`‚Ññ ${document.getElementById('claim-number').value}`, 14, 30);
    doc.text(`–ö–ª–∏–µ–Ω—Ç: ${document.getElementById('client-fio').value}`, 14, 40);
    doc.text(`–ê–≤—Ç–æ: ${document.getElementById('car-brand').value} ${document.getElementById('car-model').value} (${document.getElementById('car-number').value})`, 14, 50);
    doc.text(`–ñ–∞–ª–æ–±–∞: ${document.getElementById('complaint').value}`, 14, 60);
    doc.text(`–ò—Ç–æ–≥–æ: ${document.getElementById('total-sum').textContent} ‚ÇΩ`, 14, 70);
    
    doc.save(`–∑–∞—è–≤–∫–∞-${document.getElementById('claim-number').value}.pdf`);
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ñ–æ—Ä–º–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('auth-dialog').style.display !== 'none') {
      login();
    }
  });
</script>

</body>
</html>
