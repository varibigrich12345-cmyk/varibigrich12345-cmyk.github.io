<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Система управления СТО</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#f5f7fa; }
header { background:#2c3e50; color:#fff; padding:15px; font-size:18px; }
.hidden { display:none; }
</style>
</head>

<body>

<header>
  Система управления СТО — ООО «СЕРВИСТРАНСАВТО»
</header>

<div class="container mt-5">

  <!-- LOGIN -->
  <div id="loginScreen" class="card p-4 mx-auto" style="max-width:500px;">
    <h4 class="text-center mb-3">Вход в систему</h4>
    <input id="email" type="email" class="form-control mb-2" placeholder="Email">
    <input id="password" type="password" class="form-control mb-3" placeholder="Пароль">
    <button id="loginBtn" class="btn btn-primary w-100">Войти</button>
  </div>

  <!-- MAIN -->
  <div id="mainScreen" class="hidden">
    <div class="d-flex justify-content-between mb-3">
      <h4>Заявки</h4>
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Выйти</button>
    </div>

    <button id="createClaimBtn" class="btn btn-success mb-3">Создать заявку</button>
    <div id="claimsList" class="list-group"></div>
  </div>

</div>

<!-- MODAL -->
<div id="claimModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <form id="claimForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Новая заявка</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="car" class="form-control mb-2" placeholder="Автомобиль" required>
        <input id="problem" class="form-control mb-2" placeholder="Проблема" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Сохранить</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ================== SUPABASE ==================
const supabaseUrl = 'https://https://xvvhranmftqqddbplypu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dmhyYW5tZnRxcWRkYnBseXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Nzk2OTgsImV4cCI6MjA4MTM1NTY5OH0.nAkRjSi5lHIvGwWCfi7GI48A_XRMEtSMKuJS6V3zgi4';
const supabase = supabaseJs.createClient(supabaseUrl, supabaseKey);

// ================== ELEMENTS ==================
const loginScreen = document.getElementById('loginScreen');
const mainScreen = document.getElementById('mainScreen');
const claimsList = document.getElementById('claimsList');
const claimModalEl = document.getElementById('claimModal');
const claimModal = new bootstrap.Modal(claimModalEl);

// ================== AUTH ==================
async function checkUser() {
  const { data } = await supabase.auth.getUser();
  if (data.user) {
    loginScreen.classList.add('hidden');
    mainScreen.classList.remove('hidden');
    loadClaims();
  } else {
    loginScreen.classList.remove('hidden');
    mainScreen.classList.add('hidden');
  }
}

async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);

  checkUser();
}

async function logout() {
  await supabase.auth.signOut();
  checkUser();
}

// ================== CLAIMS ==================
async function loadClaims() {
  claimsList.innerHTML = '';
  const { data, error } = await supabase
    .from('claims')
    .select('*')
    .order('id', { ascending:false });

  if (error) return alert(error.message);

  data.forEach(c => {
    const div = document.createElement('div');
    div.className = 'list-group-item';
    div.textContent = `${c.car} — ${c.problem}`;
    claimsList.appendChild(div);
  });
}

async function saveClaim(e) {
  e.preventDefault();

  const car = document.getElementById('car').value;
  const problem = document.getElementById('problem').value;

  const { error } = await supabase
    .from('claims')
    .insert([{ car, problem }]);

  if (error) return alert(error.message);

  claimModal.hide();
  document.getElementById('claimForm').reset();
  loadClaims();
}

// ================== EVENTS ==================
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('logoutBtn').addEventListener('click', logout);
  document.getElementById('createClaimBtn').addEventListener('click', () => claimModal.show());
  document.getElementById('claimForm').addEventListener('submit', saveClaim);
  checkUser();
});
</script>

</body>
</html>
