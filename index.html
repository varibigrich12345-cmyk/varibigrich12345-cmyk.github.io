<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Система управления СТО — ООО «СЕРВИСТРАНСАВТО»</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f5f5f5; padding: 10px; }
    .hide { display: none !important; }
    .app { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header { background: #2c3e50; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; }
    .user-info { font-size: 14px; }
    .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #3498db; color: white; }.btn-primary:hover { background: #2980b9; }
    .btn-success { background: #27ae60; color: white; }.btn-success:hover { background: #229954; }
    .btn-danger { background: #e74c3c; color: white; }.btn-danger:hover { background: #c0392b; }
    .btn-secondary { background: #95a5a6; color: white; }.btn-secondary:hover { background: #7f8c8d; }
    .btn-warning { background: #f39c12; color: white; }.btn-warning:hover { background: #e67e22; }
    .search-screen { padding: 60px 20px; text-align: center; }
    .search-screen h2 { margin-bottom: 30px; color: #2c3e50; }
    .search-box { max-width: 500px; margin: 0 auto 40px; display: flex; gap: 10px; }
    .search-box input { flex: 1; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; }
    .toolbar { padding: 15px 20px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .toolbar-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
    .content { padding: 20px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
    th { background: #34495e; color: white; font-weight: 600; }
    tr:hover { background: #f8f9fa; }
    .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-draft { background: #ecf0f1; color: #7f8c8d; }
    .status-agreed { background: #d1ecf1; color: #0c5460; }
    .status-in_progress { background: #fff3cd; color: #856404; }
    .status-completed { background: #d4edda; color: #155724; }
    .form-container, .modal-body { max-width: 900px; margin: 0 auto; padding: 20px; }
    .form-group { margin: 15px 0; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-row.full { grid-template-columns: 1fr; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
    .modal.show { display: flex; align-items: start; justify-content: center; padding: 20px; }
    .modal-content { background: white; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center; }
    .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #7f8c8d; }
    .close:hover { color: #2c3e50; }
    .table-form { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .table-form th, .table-form td { padding: 8px; border: 1px solid #ddd; font-size: 13px; }
    .table-form input, .table-form select { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; }
    .table-form input[type="number"] { text-align: right; }
    @media print {
      body { background: white !important; padding: 0; }
      .app { box-shadow: none; border-radius: 0; max-width: none; }
      .no-print, .print-hide { display: none !important; }
      .header, .toolbar, .btn { display: none !important; }
      .modal { display: block !important; position: static; background: white; }
      .modal-content { max-height: none; overflow: visible; }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>Система управления СТО — ООО «СЕРВИСТРАНСАВТО»</h1>
      <div class="user-info" id="userInfo"></div>
    </div>

    <!-- Login -->
    <div id="loginScreen" class="search-screen">
      <h2>Вход в систему</h2>
      <div class="form-container">
        <div class="form-group"><input type="email" id="loginEmail" placeholder="Email"></div>
        <div class="form-group"><input type="password" id="loginPassword" placeholder="Пароль"></div>
        <button id="loginBtn" class="btn btn-primary">Войти</button>
      </div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="hide">
      <div class="toolbar">
        <div class="toolbar-title">Заявки на ремонт</div>
        <div>
          <button id="createClaimBtn" class="btn btn-success">+ Создать заявку</button>
          <button id="logoutBtn" class="btn btn-danger">Выход</button>
        </div>
      </div>
      <div class="content">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Номер</th>
                <th>Дата</th>
                <th>Госномер</th>
                <th>Авто</th>
                <th>Клиент</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="claimsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Claim Modal -->
  <div id="claimModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Новая заявка</h2>
        <span class="close" id="closeModalBtn">&times;</span>
      </div>
      <div class="modal-body">
        <form id="claimForm">
          <input type="hidden" id="claimId">
          <input type="hidden" id="claimNumber">

          <!-- Госномер и телефон -->
          <div class="form-row">
            <div><label>Госномер *</label><input type="text" id="carNumber" required></div>
            <div><label>Телефон *</label><input type="tel" id="phone" required></div>
          </div>

          <!-- Марка/Модель -->
          <div class="form-row full">
            <div><label>Марка/Модель</label><input type="text" list="carBrandList" id="carBrand"></div>
          </div>

          <!-- VIN и пробег -->
          <div class="form-row">
            <div><label>VIN</label><input type="text" id="vin"></div>
            <div><label>Пробег (км)</label><input type="number" id="mileage"></div>
          </div>

          <!-- Клиент -->
          <div class="form-row">
            <div><label>ФИО клиента *</label><input type="text" id="clientFio" required></div>
            <div><label>Компания</label><input type="text" id="clientCompany"></div>
          </div>

          <!-- Описание проблемы -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Описание проблемы</h3>
          <div class="table-container">
            <table class="table-form" id="complaintTable">
              <thead>
                <tr>
                  <th>Наименование</th><th>Сторона</th><th>Положение</th><th>Кол-во</th><th></th>
                </tr>
              </thead>
              <tbody id="complaintBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addComplaintBtn">+ Добавить</button>

          <!-- Работы -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Список работ</h3>
          <div class="table-container">
            <table class="table-form" id="worksTable">
              <thead>
                <tr>
                  <th>Наименование</th><th>Сторона</th><th>Положение</th><th>Кол-во</th>
                  <th class="print-hide">Цена</th><th class="print-hide">Сумма</th><th></th>
                </tr>
              </thead>
              <tbody id="worksBody"></tbody>
            </table>
          </div>

          <!-- Запчасти -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Запчасти</h3>
          <div class="table-container">
            <table class="table-form" id="partsTable">
              <thead>
                <tr>
                  <th>Артикул</th><th>Наименование</th><th>Сторона</th><th>Положение</th>
                  <th>Кол-во</th><th class="print-hide">Цена</th><th class="print-hide">Сумма</th><th></th>
                </tr>
              </thead>
              <tbody id="partsBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addPartBtn">+ Добавить запчасть</button>

          <!-- Итоги -->
          <div style="display:flex;justify-content:space-between;margin:20px 0;font-weight:bold;">
            <span>Итого работ: <span id="totalWorks">0 ₽</span></span>
            <span>Итого запчастей: <span id="totalParts">0 ₽</span></span>
            <span>Общая сумма: <span id="totalSum">0 ₽</span></span>
          </div>

          <!-- Статус -->
          <div class="form-row full">
            <div>
              <label>Статус</label>
              <select id="status">
                <option value="draft">Черновик</option>
                <option value="agreed">Согласовано</option>
                <option value="in_progress">В работе</option>
                <option value="completed">Завершена</option>
              </select>
            </div>
          </div>

          <!-- Кнопки -->
          <div style="margin-top:20px">
            <button type="submit" class="btn btn-success">Сохранить</button>
            <button type="button" class="btn btn-secondary" id="cancelModalBtn">Отмена</button>
            <button type="button" class="btn btn-primary" id="printBtn">Печать</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Datalists -->
  <datalist id="carBrandList">
    <option value="ГАЗель"><option value="Ford Transit"><option value="Hyundai HD78">
    <option value="Peugeot Boxer"><option value="MAN"><option value="Mercedes-Benz Sprinter">
    <option value="Volkswagen Transporter"><option value="Renault Master"><option value="IVECO Daily">
  </datalist>
  <datalist id="workList"><option value="Замена шаровой опоры"><option value="Замена тормозных колодок"></datalist>
  <datalist id="partList"><option value="Опора шаровая"><option value="Колодки тормозные"></datalist>

  <script>
    // === SUPABASE CONFIG ===
    const SUPABASE_URL = 'https://xvvhranmftqqddbplypu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dmhyYW5tZnRxcWRkYnBseXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Nzk2OTgsImV4cCI6MjA4MTM1NTY5OH0.nAkRjSi5lHIvGwWCfi7GI48A_XRMEtSMKuJS6V3zgi4';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === HELPERS ===
    const sides = ['–', 'Левая', 'Правая', 'Передняя', 'Задняя'];
    const positions = ['–', 'Верхний', 'Нижний', 'Передний', 'Задний', 'Центр'];

    const createSelect = (options, value = '') => {
      const select = document.createElement('select');
      options.forEach(opt => {
        const el = document.createElement('option');
        el.value = opt === '–' ? '' : opt;
        el.textContent = opt;
        el.selected = el.value === value;
        select.appendChild(el);
      });
      return select;
    };

    const generateClaimNumber = () => {
      const now = new Date();
      return `CLAIM-${String(now.getFullYear()).slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`;
    };

    // === TABLE ROWS ===
    const addRow = (containerId, data = null, isComplaint = false) => {
      const tbody = document.getElementById(containerId);
      const isPart = containerId === 'partsBody';
      const tr = document.createElement('tr');
      
      if (isPart) {
        tr.innerHTML = `
          <td><input type="text" list="partList" placeholder="Артикул" value="${data?.article || ''}"></td>
          <td><input type="text" list="partList" placeholder="Наименование" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          <td class="print-hide"><input type="number" min="0" value="${data?.price || 0}" style="width:80px;"></td>
          <td class="print-hide" style="text-align:right;">${(data ? (data.quantity * data.price).toFixed(2) : '0.00')} ₽</td>
          <td><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      } else {
        tr.innerHTML = `
          <td><input type="text" list="workList" placeholder="Наименование" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          ${isComplaint ? '' : `<td class="print-hide"><input type="number" min="0" value="${data?.price || 0}" style="width:80px;"></td>
          <td class="print-hide" style="text-align:right;">${(data ? (data.quantity * data.price).toFixed(2) : '0.00')} ₽</td>`}
          <td><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      }
      
      tr.querySelectorAll('td')[isPart ? 2 : 1].appendChild(createSelect(sides, data?.side));
      tr.querySelectorAll('td')[isPart ? 3 : 2].appendChild(createSelect(positions, data?.position));
      
      const btn = tr.querySelector('button');
      btn.onclick = () => {
        tr.remove();
        if (containerId === 'complaintBody') syncComplaintToWorks();
        calculateTotals();
      };
      
      tbody.appendChild(tr);
      if (!isComplaint) attachNumberEvents(tr);
      if (containerId === 'complaintBody') {
        tr.querySelector('input').addEventListener('input', () => syncComplaintToWorks());
      }
    };

    const attachNumberEvents = (row) => {
      row.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });
    };

    const syncComplaintToWorks = () => {
      const worksBody = document.getElementById('worksBody');
      worksBody.innerHTML = '';
      document.querySelectorAll('#complaintBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const name = inputs[0].value;
        if (!name) return;
        addRow('worksBody', {
          name: name,
          side: inputs[1].value,
          position: inputs[2].value,
          quantity: parseInt(inputs[3].value) || 1,
          price: 0
        });
      });
    };

    const calculateTotals = () => {
      let totalWorks = 0;
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const qty = parseFloat(cells[3].querySelector('input').value) || 0;
        const price = parseFloat((cells[4] || {querySelector: () => ({value:0})}).querySelector('input')?.value) || 0;
        const sum = qty * price;
        if (cells[5]) cells[5].textContent = `${sum.toFixed(2)} ₽`;
        totalWorks += sum;
      });

      let totalParts = 0;
      document.querySelectorAll('#partsBody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const qty = parseFloat(cells[4].querySelector('input').value) || 0;
        const price = parseFloat(cells[5].querySelector('input').value) || 0;
        const sum = qty * price;
        cells[6].textContent = `${sum.toFixed(2)} ₽`;
        totalParts += sum;
      });

      document.getElementById('totalWorks').textContent = `${totalWorks.toFixed(2)} ₽`;
      document.getElementById('totalParts').textContent = `${totalParts.toFixed(2)} ₽`;
      document.getElementById('totalSum').textContent = `${(totalWorks + totalParts).toFixed(2)} ₽`;
    };

    // === MAIN FUNCTIONS ===
    const login = async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      if (!email || !password) return alert('Введите email и пароль');
      
      btn.disabled = true;
      btn.innerHTML = '<span style="display:inline-block;width:20px;height:20px;border:3px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin 1s linear infinite"></span>';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        checkUser();
      } catch (err) {
        alert('Ошибка: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Войти';
      }
    };

    const logout = async () => {
      await supabase.auth.signOut();
      checkUser();
    };

    const checkUser = async () => {
      const { data, error } = await supabase.auth.getUser();
      const loginScreen = document.getElementById('loginScreen');
      const mainScreen = document.getElementById('mainScreen');
      const userInfo = document.getElementById('userInfo');
      
      if (error || !data?.user) {
        loginScreen.classList.remove('hide');
        mainScreen.classList.add('hide');
        userInfo.textContent = '';
      } else {
        loginScreen.classList.add('hide');
        mainScreen.classList.remove('hide');
        userInfo.textContent = data.user.email;
        loadClaims();
      }
    };

    const loadClaims = async () => {
      const { data, error } = await supabase
        .from('claims')
        .select('*')
        .order('created_at', { ascending: false });
      
      const body = document.getElementById('claimsBody');
      if (error) return body.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#e74c3c;padding:20px;">Ошибка: ${error.message}</td></tr>`;
      if (!data?.length) return body.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#7f8c8d;padding:20px;">Нет заявок</td></tr>';
      
      body.innerHTML = data.map(c => `
        <tr>
          <td>${c.number || '-'}</td>
          <td>${new Date(c.created_at).toLocaleString()}</td>
          <td>${c.car_number || '-'}</td>
          <td>${c.car_brand || '-'}</td>
          <td>${c.client_fio}</td>
          <td>${c.phone}</td>
          <td><span class="status status-${c.status}">${c.status}</span></td>
          <td><button class="btn btn-secondary" onclick="editClaim('${c.id}')">Редактировать</button></td>
        </tr>
      `).join('');
    };

    const saveClaim = async (e) => {
      e.preventDefault();
      
      // === КРИТИЧЕСКИ ВАЖНО: безопасное извлечение user ===
      const { data, error: userError } = await supabase.auth.getUser();
      const user = data?.user;
      
      if (userError || !user) return alert('Сначала войдите в систему');
      
      // Сбор данных
      const complaint = [], works = [], parts = [];
      document.querySelectorAll('#complaintBody tr').forEach(tr => {
        const [name, side, pos, qty] = Array.from(tr.querySelectorAll('input,select')).map(el => el.value);
        if (name) complaint.push({name, side, position: pos, quantity: +qty || 1});
      });
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const [name, side, pos, qty, price] = Array.from(tr.querySelectorAll('input,select')).map(el => el.value);
        if (name) works.push({name, side, position: pos, quantity: +qty || 1, price: +price || 0});
      });
      document.querySelectorAll('#partsBody tr').forEach(tr => {
        const [art, name, side, pos, qty, price] = Array.from(tr.querySelectorAll('input,select')).map(el => el.value);
        if (name || art) parts.push({article: art, name, side, position: pos, quantity: +qty || 1, price: +price || 0});
      });

      const claimData = {
        car_number: document.getElementById('carNumber').value,
        car_brand: document.getElementById('carBrand').value,
        vin: document.getElementById('vin').value,
        mileage: parseInt(document.getElementById('mileage').value) || null,
        client_fio: document.getElementById('clientFio').value,
        client_company: document.getElementById('clientCompany').value,
        phone: document.getElementById('phone').value,
        complaint: complaint,
        works: works,
        parts: parts,
        status: document.getElementById('status').value,
        number: document.getElementById('claimNumber').value,
        user_id: user.id
      };

      const id = document.getElementById('claimId').value;
      const { error } = id 
        ? await supabase.from('claims').update(claimData).eq('id', id)
        : await supabase.from('claims').insert([claimData]);

      if (error) {
        console.error('Supabase error:', error);
        alert('Ошибка сохранения: ' + error.message);
      } else {
        alert('Заявка сохранена!');
        closeModal();
        loadClaims();
      }
    };

    const showClaimForm = () => {
      document.getElementById('claimId').value = '';
      document.getElementById('claimNumber').value = generateClaimNumber();
      document.getElementById('modalTitle').textContent = 'Новая заявка';
      
      ['carNumber','carBrand','vin','mileage','clientFio','clientCompany','phone'].forEach(id => 
        document.getElementById(id).value = ''
      );
      document.getElementById('status').value = 'draft';
      
      document.getElementById('complaintBody').innerHTML = '';
      document.getElementById('worksBody').innerHTML = '';
      document.getElementById('partsBody').innerHTML = '';
      
      addRow('complaintBody');
      addRow('partsBody');
      calculateTotals();
      
      document.getElementById('claimModal').classList.add('show');
    };

    const editClaim = (id) => { alert('Редактирование — в разработке'); };
    const closeModal = () => { document.getElementById('claimModal').classList.remove('show'); };
    const printClaim = () => { window.print(); };

    // === INIT ===
    document.addEventListener('DOMContentLoaded', () => {
      // Кнопки
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('createClaimBtn').addEventListener('click', showClaimForm);
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
      document.getElementById('printBtn').addEventListener('click', printClaim);
      document.getElementById('addComplaintBtn').addEventListener('click', () => addRow('complaintBody'));
      document.getElementById('addPartBtn').addEventListener('click', () => addRow('partsBody'));
      document.getElementById('claimForm').addEventListener('submit', saveClaim);
      
      // Закрытие модалки по клику на фон
      document.getElementById('claimModal').addEventListener('click', e => {
        if (e.target.id === 'claimModal') closeModal();
      });

      checkUser();
    });
  </script>
</body>
</html>
