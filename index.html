<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Система управления СТО — ООО «СЕРВИСТРАНСАВТО»</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Стили остаются без изменений */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f5f5f5; padding: 10px; }
    .hide { display: none !important; }
    .app { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header { background: #2c3e50; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; }
    .user-info { font-size: 14px; position: relative; }
    .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #3498db; color: white; }.btn-primary:hover { background: #2980b9; }
    .btn-success { background: #27ae60; color: white; }.btn-success:hover { background: #229954; }
    .btn-danger { background: #e74c3c; color: white; }.btn-danger:hover { background: #c0392b; }
    .btn-secondary { background: #95a5a6; color: white; }.btn-secondary:hover { background: #7f8c8d; }
    .btn-warning { background: #f39c12; color: white; }.btn-warning:hover { background: #e67e22; }
    .btn-small { padding: 5px 10px; font-size: 12px; }
    .search-screen { padding: 60px 20px; text-align: center; }
    .search-screen h2 { margin-bottom: 30px; color: #2c3e50; }
    .search-box { max-width: 500px; margin: 0 auto 40px; display: flex; gap: 10px; }
    .search-box input { flex: 1; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; }
    .toolbar { padding: 15px 20px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .toolbar-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
    .content { padding: 20px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
    th { background: #34495e; color: white; font-weight: 600; }
    tr:hover { background: #f8f9fa; }
    .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-draft { background: #ecf0f1; color: #7f8c8d; }
    .status-agreed { background: #d1ecf1; color: #0c5460; }
    .status-in_progress { background: #fff3cd; color: #856404; }
    .status-completed { background: #d4edda; color: #155724; }
    .form-container, .modal-body { max-width: 900px; margin: 0 auto; padding: 20px; }
    .form-group { margin: 15px 0; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-row.full { grid-template-columns: 1fr; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
    .modal.show { display: flex; align-items: start; justify-content: center; padding: 20px; }
    .modal-content { background: white; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center; }
    .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #7f8c8d; }
    .close:hover { color: #2c3e50; }
    .table-form { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .table-form th, .table-form td { padding: 8px; border: 1px solid #ddd; font-size: 13px; }
    .table-form input, .table-form select { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; }
    .table-form input[type="number"] { text-align: right; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
    .error-message { background: #fee; color: #c00; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .success-message { background: #dfd; color: #070; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .account-menu { position: absolute; top: 40px; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; display: none; }
    .account-menu.show { display: block; }
    .account-menu-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
    .account-menu-item:hover { background: #f8f9fa; }
    .account-menu-item:last-child { border-bottom: none; color: #e74c3c; }
    .account-menu-icon { width: 16px; height: 16px; }
    .user-display { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: background 0.2s; }
    .user-display:hover { background: rgba(255,255,255,0.1); }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .user-details { display: flex; flex-direction: column; }
    .user-name { font-weight: 600; font-size: 14px; }
    .user-role { font-size: 11px; color: #bdc3c7; }
    .masked-email { font-family: monospace; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-size: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media print {
      body { background: white !important; padding: 0; }
      .app { box-shadow: none; border-radius: 0; max-width: none; }
      .no-print, .print-hide, .btn { display: none !important; }
      .modal { display: block !important; position: static; background: white; }
      .modal-content { max-height: none; overflow: visible; border: 1px solid #000; }
    }
    .search-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .search-filters input, .search-filters select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .validation-error { color: #e74c3c; font-size: 12px; margin-top: 5px; display: none; }
    .validation-error.show { display: block; }
    input.error { border-color: #e74c3c !important; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>Система управления СТО — ООО «СЕРВИСТРАНСАВТО»</h1>
      <div class="user-info" id="userInfo"></div>
    </div>

    <!-- Login -->
    <div id="loginScreen" class="search-screen">
      <h2>Вход в систему</h2>
      <div class="form-container">
        <div id="loginError" class="error-message hide"></div>
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="Введите ваш email" autocomplete="username">
          <div class="validation-error" id="emailError">Введите корректный email</div>
        </div>
        <div class="form-group">
          <label for="loginPassword">Пароль</label>
          <input type="password" id="loginPassword" placeholder="Введите ваш пароль" autocomplete="current-password">
          <div class="validation-error" id="passwordError">Введите пароль</div>
        </div>
        <button id="loginBtn" class="btn btn-primary">Войти</button>
      </div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="hide">
      <div class="toolbar">
        <div class="toolbar-title">Заявки на ремонт</div>
        <div>
          <button id="createClaimBtn" class="btn btn-success">+ Создать заявку</button>
          <button id="logoutBtn" class="btn btn-danger">Выход</button>
        </div>
      </div>
      <div class="content">
        <!-- Поиск и фильтры -->
        <div class="search-filters">
          <input type="text" id="searchInput" placeholder="Поиск по номеру, госномеру или клиенту..." style="flex: 2;">
          <input type="text" id="searchCarNumber" placeholder="Госномер">
          <select id="filterStatus">
            <option value="">Все статусы</option>
            <option value="draft">Черновик</option>
            <option value="agreed">Согласовано</option>
            <option value="in_progress">В работе</option>
            <option value="completed">Завершена</option>
          </select>
          <button id="searchBtn" class="btn btn-primary">Поиск</button>
          <button id="clearSearchBtn" class="btn btn-secondary">Сбросить</button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Номер</th>
                <th>Дата</th>
                <th>Госномер</th>
                <th>Авто</th>
                <th>Клиент</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Сумма</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="claimsBody"><tr><td colspan="9" style="text-align:center;padding:20px;color:#7f8c8d;">Нет заявок</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Claim Modal -->
  <div id="claimModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Новая заявка</h2>
        <span class="close" id="closeModalBtn">&times;</span>
      </div>
      <div class="modal-body">
        <form id="claimForm">
          <input type="hidden" id="claimId">
          <input type="hidden" id="claimNumber">

          <!-- Госномер и телефон -->
          <div class="form-row">
            <div class="form-group">
              <label>Госномер *</label>
              <input type="text" id="carNumber" required pattern="[А-Яа-я]\d{3}[А-Яа-я]{2}\d{2,3}" title="Формат: А123БВ45">
              <small style="color:#666">Формат: А123БВ45 или А123БВ123</small>
              <div class="validation-error" id="carNumberError">Введите корректный госномер</div>
            </div>
            <div class="form-group">
              <label>Телефон *</label>
              <input type="tel" id="phone" required pattern="^[\d\s\-\+\(\)]{10,}$" title="Минимум 10 цифр">
              <div class="validation-error" id="phoneError">Введите корректный телефон</div>
            </div>
          </div>

          <!-- Марка/Модель -->
          <div class="form-row full">
            <div class="form-group">
              <label>Марка/Модель</label>
              <input type="text" list="carBrandList" id="carBrand">
            </div>
          </div>

          <!-- VIN и пробег -->
          <div class="form-row">
            <div class="form-group">
              <label>VIN</label>
              <input type="text" id="vin">
            </div>
            <div class="form-group">
              <label>Пробег (км)</label>
              <input type="number" id="mileage" min="0">
            </div>
          </div>

          <!-- Клиент -->
          <div class="form-row">
            <div class="form-group">
              <label>ФИО клиента *</label>
              <input type="text" id="clientFio" required>
              <div class="validation-error" id="clientFioError">Введите ФИО клиента</div>
            </div>
            <div class="form-group">
              <label>Компания</label>
              <input type="text" id="clientCompany">
            </div>
          </div>

          <!-- Описание проблемы -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Описание проблемы</h3>
          <div class="table-container">
            <table class="table-form" id="complaintTable">
              <thead>
                <tr>
                  <th>Наименование</th><th>Сторона</th><th>Положение</th><th>Кол-во</th><th></th>
                </tr>
              </thead>
              <tbody id="complaintBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addComplaintBtn">+ Добавить</button>

          <!-- Работы -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Список работ</h3>
          <div class="table-container">
            <table class="table-form" id="worksTable">
              <thead>
                <tr>
                  <th>Наименование</th><th>Сторона</th><th>Положение</th><th>Кол-во</th>
                  <th class="print-hide">Цена</th><th class="print-hide">Сумма</th><th></th>
                </tr>
              </thead>
              <tbody id="worksBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addWorkBtn">+ Добавить работу</button>

          <!-- Запчасти -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Запчасти</h3>
          <div class="table-container">
            <table class="table-form" id="partsTable">
              <thead>
                <tr>
                  <th>Артикул</th><th>Наименование</th><th>Сторона</th><th>Положение</th>
                  <th>Кол-во</th><th class="print-hide">Цена</th><th class="print-hide">Сумма</th><th></th>
                </tr>
              </thead>
              <tbody id="partsBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addPartBtn">+ Добавить запчасть</button>

          <!-- Итоги -->
          <div style="display:flex;justify-content:space-between;margin:20px 0;font-weight:bold;">
            <span>Итого работ: <span id="totalWorks">0 ₽</span></span>
            <span>Итого запчастей: <span id="totalParts">0 ₽</span></span>
            <span>Общая сумма: <span id="totalSum">0 ₽</span></span>
          </div>

          <!-- Статус -->
          <div class="form-row full">
            <div class="form-group">
              <label>Статус</label>
              <select id="status">
                <option value="draft">Черновик</option>
                <option value="agreed">Согласовано</option>
                <option value="in_progress">В работе</option>
                <option value="completed">Завершена</option>
              </select>
            </div>
          </div>

          <!-- Кнопки -->
          <div style="margin-top:20px">
            <button type="submit" class="btn btn-success">Сохранить</button>
            <button type="button" class="btn btn-secondary" id="cancelModalBtn">Отмена</button>
            <button type="button" class="btn btn-primary no-print" id="printBtn">Печать</button>
            <button type="button" class="btn btn-danger no-print" id="deleteClaimBtn" style="display:none">Удалить заявку</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Datalists -->
  <datalist id="carBrandList">
    <option value="ГАЗель"><option value="Ford Transit"><option value="Hyundai HD78">
    <option value="Peugeot Boxer"><option value="MAN"><option value="Mercedes-Benz Sprinter">
    <option value="Volkswagen Transporter"><option value="Renault Master"><option value="IVECO Daily">
  </datalist>
  <datalist id="workList">
    <option value="Замена шаровой опоры"><option value="Замена тормозных колодок"><option value="Замена масла">
    <option value="Замена фильтров"><option value="Регулировка развала-схождения"><option value="Диагностика">
    <option value="Замена АКБ"><option value="Замена шин"><option value="Ремонт двигателя">
  </datalist>
  <datalist id="partList">
    <option value="Опора шаровая"><option value="Колодки тормозные"><option value="Масло моторное">
    <option value="Фильтр воздушный"><option value="Фильтр масляный"><option value="Аккумулятор">
    <option value="Шина"><option value="Диск"><option value="Свечи зажигания">
  </datalist>

  <script>
    // === SUPABASE CONFIG ===
    const SUPABASE_URL = 'https://xvvhranmftqqddbplypu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dmhyYW5tZnRxcWRkYnBseXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Nzk2OTgsImV4cCI6MjA4MTM1NTY5OH0.nAkRjSi5lHIvGwWCfi7GI48A_XRMEtSMKuJS6V3zgi4';
    
    let supabase;
    if (!window.supabaseClient) {
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
    supabase = window.supabaseClient;

    // === CONSTANTS ===
    const STATUS_LABELS = {
      draft: 'Черновик',
      agreed: 'Согласовано',
      in_progress: 'В работе',
      completed: 'Завершена'
    };

    const SIDES = ['–', 'Левая', 'Правая', 'Передняя', 'Задняя'];
    const POSITIONS = ['–', 'Верхний', 'Нижний', 'Передний', 'Задний', 'Центр'];

    // === GLOBAL STATE ===
    let currentClaims = [];
    let currentUser = null;

    // === HELPER FUNCTIONS ===
    const maskEmail = (email) => {
      if (!email) return '';
      
      const cleanEmail = email.split(':').pop().trim();
      const [username, domain] = cleanEmail.split('@');
      
      if (!username || !domain) return '***@***';
      
      // Обработка email с плюсом (как в vanbapten12345+master10@gmail.com)
      const baseUsername = username.split('+')[0];
      const maskedUsername = baseUsername.length > 3 
        ? baseUsername.substring(0, 3) + '*'.repeat(Math.min(baseUsername.length - 3, 4))
        : '*'.repeat(baseUsername.length);
      
      return `${maskedUsername}@${domain}`;
    };

    const getUserInitials = (name) => {
      if (!name) return '?';
      const parts = name.split(' ');
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    };

    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('ru-RU', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
      }).format(amount) + ' ₽';
    };

    const createSelect = (options, value = '') => {
      const select = document.createElement('select');
      options.forEach(opt => {
        const el = document.createElement('option');
        el.value = opt === '–' ? '' : opt;
        el.textContent = opt;
        el.selected = el.value === value;
        select.appendChild(el);
      });
      return select;
    };

    const generateClaimNumber = () => {
      const now = new Date();
      return `CLAIM-${String(now.getFullYear()).slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`;
    };

    const showValidationError = (elementId, message) => {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.classList.add('show');
      document.getElementById(elementId.replace('Error', '')).classList.add('error');
    };

    const hideValidationError = (elementId) => {
      const errorElement = document.getElementById(elementId);
      errorElement.classList.remove('show');
      document.getElementById(elementId.replace('Error', '')).classList.remove('error');
    };

    const showMessage = (elementId, message, isError = false) => {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = isError ? 'error-message' : 'success-message';
      element.classList.remove('hide');
      
      if (!isError) {
        setTimeout(() => element.classList.add('hide'), 3000);
      }
    };

    // === TABLE ROW FUNCTIONS ===
    const addRow = (containerId, data = null, isComplaint = false) => {
      const tbody = document.getElementById(containerId);
      const isPart = containerId === 'partsBody';
      const isWork = containerId === 'worksBody';
      const tr = document.createElement('tr');
      
      if (isPart) {
        tr.innerHTML = `
          <td><input type="text" list="partList" placeholder="Артикул" value="${data?.article || ''}"></td>
          <td><input type="text" list="partList" placeholder="Наименование" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          <td class="print-hide"><input type="number" min="0" step="0.01" value="${data?.price || 0}" style="width:80px;"></td>
          <td class="print-hide" style="text-align:right;">${formatCurrency((data?.quantity || 0) * (data?.price || 0))}</td>
          <td class="no-print"><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      } else if (isWork) {
        tr.innerHTML = `
          <td><input type="text" list="workList" placeholder="Наименование" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          <td class="print-hide"><input type="number" min="0" step="0.01" value="${data?.price || 0}" style="width:80px;"></td>
          <td class="print-hide" style="text-align:right;">${formatCurrency((data?.quantity || 0) * (data?.price || 0))}</td>
          <td class="no-print"><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      } else {
        tr.innerHTML = `
          <td><input type="text" placeholder="Описание проблемы" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          <td class="no-print"><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      }
      
      const sideCell = isPart ? 2 : isWork ? 1 : 1;
      const positionCell = isPart ? 3 : isWork ? 2 : 2;
      
      tr.querySelectorAll('td')[sideCell].appendChild(createSelect(SIDES, data?.side));
      tr.querySelectorAll('td')[positionCell].appendChild(createSelect(POSITIONS, data?.position));
      
      const deleteBtn = tr.querySelector('button');
      deleteBtn.onclick = () => {
        if (confirm('Удалить эту запись?')) {
          tr.remove();
          if (isComplaint) syncComplaintToWorks();
          calculateTotals();
        }
      };
      
      if (!isComplaint) {
        const inputs = tr.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          input.addEventListener('input', calculateTotals);
        });
      }
      
      if (isComplaint) {
        tr.querySelector('input[type="text"]').addEventListener('input', () => syncComplaintToWorks());
        tr.querySelectorAll('select').forEach(select => {
          select.addEventListener('change', () => syncComplaintToWorks());
        });
      }
      
      tbody.appendChild(tr);
      return tr;
    };

    const syncComplaintToWorks = () => {
      const priceMap = {};
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const nameInput = tr.querySelector('td:first-child input');
        const priceInput = tr.querySelector('td:nth-child(5) input');
        if (nameInput && nameInput.value && priceInput) {
          priceMap[nameInput.value] = parseFloat(priceInput.value) || 0;
        }
      });
      
      const complaints = [];
      document.querySelectorAll('#complaintBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const name = inputs[0].value;
        if (!name) return;
        
        complaints.push({
          name: name,
          side: inputs[1].value,
          position: inputs[2].value,
          quantity: parseInt(inputs[3].value) || 1
        });
      });
      
      const worksBody = document.getElementById('worksBody');
      worksBody.innerHTML = '';
      
      complaints.forEach(complaint => {
        addRow('worksBody', {
          name: complaint.name,
          side: complaint.side,
          position: complaint.position,
          quantity: complaint.quantity,
          price: priceMap[complaint.name] || 0
        });
      });
      
      calculateTotals();
    };

    const calculateTotals = () => {
      let totalWorks = 0;
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const qty = parseFloat(cells[3].querySelector('input').value) || 0;
        const price = parseFloat(cells[4].querySelector('input').value) || 0;
        const sum = qty * price;
        if (cells[5]) cells[5].textContent = formatCurrency(sum);
        totalWorks += sum;
      });

      let totalParts = 0;
      document.querySelectorAll('#partsBody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const qty = parseFloat(cells[4].querySelector('input').value) || 0;
        const price = parseFloat(cells[5].querySelector('input').value) || 0;
        const sum = qty * price;
        cells[6].textContent = formatCurrency(sum);
        totalParts += sum;
      });

      document.getElementById('totalWorks').textContent = formatCurrency(totalWorks);
      document.getElementById('totalParts').textContent = formatCurrency(totalParts);
      document.getElementById('totalSum').textContent = formatCurrency(totalWorks + totalParts);
    };

    // === AUTH FUNCTIONS ===
    const login = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      
      hideValidationError('emailError');
      hideValidationError('passwordError');
      
      let isValid = true;
      
      // Исправленная валидация email (разрешает знак +)
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showValidationError('emailError', 'Введите корректный email');
        isValid = false;
      }
      
      if (!password) {
        showValidationError('passwordError', 'Введите пароль');
        isValid = false;
      }
      
      if (!isValid) return;
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Вход...';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) throw error;
        
        currentUser = data.user;
        checkUser();
        showMessage('loginError', 'Вход выполнен успешно!', false);
        
      } catch (err) {
        showMessage('loginError', 'Ошибка входа: ' + err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Войти';
      }
    };

    const logout = async () => {
      if (confirm('Вы уверены, что хотите выйти?')) {
        await supabase.auth.signOut();
        currentUser = null;
        currentClaims = [];
        checkUser();
      }
    };

    const checkUser = async () => {
      try {
        const { data, error } = await supabase.auth.getSession();
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const userInfo = document.getElementById('userInfo');
        
        if (error || !data?.session?.user) {
          loginScreen.classList.remove('hide');
          mainScreen.classList.add('hide');
          userInfo.innerHTML = '';
          currentUser = null;
        } else {
          loginScreen.classList.add('hide');
          mainScreen.classList.remove('hide');
          currentUser = data.session.user;
          
          const maskedEmail = maskEmail(data.session.user.email);
          const userName = data.session.user.user_metadata?.full_name || 
                          data.session.user.email.split('@')[0].split(':').pop();
          const initials = getUserInitials(userName);
          
          userInfo.innerHTML = `
            <div class="user-display">
              <div class="user-avatar">${initials}</div>
              <div class="user-details">
                <div class="user-name">${userName}</div>
                <div class="user-role">${maskedEmail}</div>
              </div>
            </div>
          `;
          
          loadClaims();
        }
      } catch (error) {
        console.error('Error checking user:', error);
        document.getElementById('loginScreen').classList.remove('hide');
        document.getElementById('mainScreen').classList.add('hide');
      }
    };

    // === CLAIMS FUNCTIONS ===
    const loadClaims = async (filters = {}) => {
      const body = document.getElementById('claimsBody');
      body.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:#7f8c8d;">Загрузка...</td></tr>';
      
      try {
        let query = supabase
          .from('claims')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (filters.search) {
          query = query.or(`number.ilike.%${filters.search}%,car_number.ilike.%${filters.search}%,client_fio.ilike.%${filters.search}%`);
        }
        
        if (filters.carNumber) {
          query = query.ilike('car_number', `%${filters.carNumber}%`);
        }
        
        if (filters.status) {
          query = query.eq('status', filters.status);
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        currentClaims = data || [];
        renderClaimsTable(currentClaims);
        
      } catch (error) {
        body.innerHTML = `<tr><td colspan="9" style="text-align:center;color:#e74c3c;padding:20px;">Ошибка загрузки: ${error.message}</td></tr>`;
        alert('Ошибка при загрузке заявок: ' + error.message);
      }
    };

    const renderClaimsTable = (claims) => {
      const body = document.getElementById('claimsBody');
      
      if (!claims || claims.length === 0) {
        body.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#7f8c8d;padding:20px;">Нет заявок</td></tr>';
        return;
      }
      
      body.innerHTML = claims.map(claim => {
        const worksTotal = (claim.works || []).reduce((sum, work) => sum + (work.quantity * work.price), 0);
        const partsTotal = (claim.parts || []).reduce((sum, part) => sum + (part.quantity * part.price), 0);
        const totalAmount = worksTotal + partsTotal;
        
        return `
          <tr>
            <td>${claim.number || 'N/A'}</td>
            <td>${new Date(claim.created_at).toLocaleDateString('ru-RU')}</td>
            <td>${claim.car_number || '-'}</td>
            <td>${claim.car_brand || '-'}</td>
            <td>${claim.client_fio || '-'}</td>
            <td>${claim.phone || '-'}</td>
            <td><span class="status status-${claim.status}">${STATUS_LABELS[claim.status] || claim.status}</span></td>
            <td>${formatCurrency(totalAmount)}</td>
            <td>
              <button class="btn btn-secondary" onclick="app.editClaim('${claim.id}')">Редактировать</button>
              <button class="btn btn-primary" onclick="app.printClaimById('${claim.id}')">Печать</button>
            </td>
          </tr>
        `;
      }).join('');
    };

    const searchClaims = () => {
      const searchTerm = document.getElementById('searchInput').value.trim();
      const carNumber = document.getElementById('searchCarNumber').value.trim();
      const status = document.getElementById('filterStatus').value;
      
      loadClaims({
        search: searchTerm,
        carNumber: carNumber,
        status: status
      });
    };

    const clearSearch = () => {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchCarNumber').value = '';
      document.getElementById('filterStatus').value = '';
      loadClaims();
    };

    const showClaimForm = (claim = null) => {
      const isEdit = !!claim;
      
      document.getElementById('claimId').value = isEdit ? claim.id : '';
      document.getElementById('claimNumber').value = isEdit ? claim.number : generateClaimNumber();
      document.getElementById('modalTitle').textContent = isEdit ? 'Редактирование заявки' : 'Новая заявка';
      
      // Сброс всех ошибок валидации
      ['carNumber', 'phone', 'clientFio'].forEach(field => {
        hideValidationError(`${field}Error`);
      });
      
      // Полный сброс формы
      document.getElementById('claimForm').reset();
      
      // Полная очистка таблиц
      document.getElementById('complaintBody').innerHTML = '';
      document.getElementById('worksBody').innerHTML = '';
      document.getElementById('partsBody').innerHTML = '';
      
      if (isEdit) {
        document.getElementById('carNumber').value = claim.car_number || '';
        document.getElementById('carBrand').value = claim.car_brand || '';
        document.getElementById('vin').value = claim.vin || '';
        document.getElementById('mileage').value = claim.mileage || '';
        document.getElementById('clientFio').value = claim.client_fio || '';
        document.getElementById('clientCompany').value = claim.client_company || '';
        document.getElementById('phone').value = claim.phone || '';
        document.getElementById('status').value = claim.status || 'draft';
        
        // Заполнение таблиц данными из базы
        (claim.complaint || []).forEach(item => addRow('complaintBody', item, true));
        (claim.works || []).forEach(item => addRow('worksBody', item, false));
        (claim.parts || []).forEach(item => addRow('partsBody', item, false));
        
        document.getElementById('deleteClaimBtn').style.display = 'inline-block';
      } else {
        // Новая заявка - добавляем пустые строки
        document.getElementById('status').value = 'draft';
        
        // Добавляем по одной пустой строке в каждую таблицу
        addRow('complaintBody', null, true);
        addRow('worksBody', null, false);
        addRow('partsBody', null, false);
        
        document.getElementById('deleteClaimBtn').style.display = 'none';
      }
      
      calculateTotals();
      document.getElementById('claimModal').classList.add('show');
    };

    const validateClaimForm = () => {
      let isValid = true;
      
      const carNumber = document.getElementById('carNumber').value.trim();
      if (!carNumber || !/^[А-Яа-я]\d{3}[А-Яа-я]{2}\d{2,3}$/i.test(carNumber)) {
        showValidationError('carNumberError', 'Введите корректный госномер (формат: А123БВ45)');
        isValid = false;
      } else {
        hideValidationError('carNumberError');
      }
      
      // Исправленное регулярное выражение для телефона
      const phone = document.getElementById('phone').value.trim();
      if (!phone || !/^[\d\s\-\+\(\)]{10,}$/.test(phone.replace(/[^\d]/g, ''))) {
        showValidationError('phoneError', 'Введите корректный телефон (минимум 10 цифр)');
        isValid = false;
      } else {
        hideValidationError('phoneError');
      }
      
      const clientFio = document.getElementById('clientFio').value.trim();
      if (!clientFio) {
        showValidationError('clientFioError', 'Введите ФИО клиента');
        isValid = false;
      } else {
        hideValidationError('clientFioError');
      }
      
      return isValid;
    };

    const saveClaim = async (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        alert('Сначала войдите в систему');
        return;
      }
      
      if (!validateClaimForm()) {
        return;
      }
      
      const complaint = [], works = [], parts = [];
      
      document.querySelectorAll('#complaintBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const name = inputs[0].value.trim();
        if (name) {
          complaint.push({
            name: name,
            side: inputs[1].value,
            position: inputs[2].value,
            quantity: parseInt(inputs[3].value) || 1
          });
        }
      });
      
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const name = inputs[0].value.trim();
        if (name) {
          works.push({
            name: name,
            side: inputs[1].value,
            position: inputs[2].value,
            quantity: parseInt(inputs[3].value) || 1,
            price: parseFloat(inputs[4].value) || 0
          });
        }
      });
      
      document.querySelectorAll('#partsBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const article = inputs[0].value.trim();
        const name = inputs[1].value.trim();
        if (name || article) {
          parts.push({
            article: article,
            name: name,
            side: inputs[2].value,
            position: inputs[3].value,
            quantity: parseInt(inputs[4].value) || 1,
            price: parseFloat(inputs[5].value) || 0
          });
        }
      });
      
      const claimData = {
        car_number: document.getElementById('carNumber').value.trim(),
        car_brand: document.getElementById('carBrand').value.trim(),
        vin: document.getElementById('vin').value.trim(),
        mileage: parseInt(document.getElementById('mileage').value) || null,
        client_fio: document.getElementById('clientFio').value.trim(),
        client_company: document.getElementById('clientCompany').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        complaint: complaint,
        works: works,
        parts: parts,
        status: document.getElementById('status').value,
        number: document.getElementById('claimNumber').value,
        user_id: currentUser.id
      };
      
      try {
        const claimId = document.getElementById('claimId').value;
        let result;
        
        if (claimId) {
          result = await supabase
            .from('claims')
            .update(claimData)
            .eq('id', claimId);
        } else {
          result = await supabase
            .from('claims')
            .insert([claimData]);
        }
        
        const { error } = result;
        
        if (error) throw error;
        
        alert('Заявка успешно сохранена!');
        closeModal();
        loadClaims();
        
      } catch (error) {
        console.error('Supabase error:', error);
        alert('Ошибка сохранения: ' + error.message);
      }
    };

    const editClaim = async (id) => {
      try {
        const { data, error } = await supabase
          .from('claims')
          .select('*')
          .eq('id', id)
          .single();
        
        if (error) throw error;
        
        showClaimForm(data);
        
      } catch (error) {
        alert('Ошибка загрузки заявки: ' + error.message);
      }
    };

    const deleteClaim = async () => {
      const claimId = document.getElementById('claimId').value;
      
      if (!claimId) return;
      
      if (confirm('Вы уверены, что хотите удалить эту заявку? Это действие нельзя отменить.')) {
        try {
          const { error } = await supabase
            .from('claims')
            .delete()
            .eq('id', claimId);
          
          if (error) throw error;
          
          alert('Заявка удалена!');
          closeModal();
          loadClaims();
          
        } catch (error) {
          alert('Ошибка удаления: ' + error.message);
        }
      }
    };

    const printClaimById = (id) => {
      const claim = currentClaims.find(c => c.id === id);
      if (!claim) return;
      
      showClaimForm(claim);
      setTimeout(() => {
        window.print();
      }, 100);
    };

    const closeModal = () => {
      document.getElementById('claimModal').classList.remove('show');
    };

    const printClaim = () => {
      window.print();
    };

    // === GLOBAL APP OBJECT ===
    window.app = {
      editClaim,
      printClaimById,
      logout
    };

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', () => {
      // Кнопки
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('createClaimBtn').addEventListener('click', () => showClaimForm());
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
      document.getElementById('printBtn').addEventListener('click', printClaim);
      document.getElementById('deleteClaimBtn').addEventListener('click', deleteClaim);
      
      // Добавление строк в таблицы
      document.getElementById('addComplaintBtn').addEventListener('click', () => addRow('complaintBody', null, true));
      document.getElementById('addWorkBtn').addEventListener('click', () => addRow('worksBody', null, false));
      document.getElementById('addPartBtn').addEventListener('click', () => addRow('partsBody', null, false));
      
      // Поиск
      document.getElementById('searchBtn').addEventListener('click', searchClaims);
      document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
      
      // Поиск по Enter
      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchClaims();
      });
      
      // Автовход по Enter на форме входа
      document.getElementById('loginPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
      });
      
      // Форма
      document.getElementById('claimForm').addEventListener('submit', saveClaim);
      
      // Закрытие модалки
      document.getElementById('claimModal').addEventListener('click', (e) => {
        if (e.target.id === 'claimModal') closeModal();
      });
      
      // Проверка пользователя при загрузке
      checkUser();
    });
  </script>
</body>
</html>
