<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Система управления СТО — ООО «СЕРВИСТРАНСАВТО»</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f5f5f5; padding: 10px; }
    .hide { display: none !important; }
    .app { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header { background: #2c3e50; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; }
    .user-info { font-size: 14px; position: relative; }
    .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #3498db; color: white; }.btn-primary:hover { background: #2980b9; }
    .btn-success { background: #27ae60; color: white; }.btn-success:hover { background: #229954; }
    .btn-danger { background: #e74c3c; color: white; }.btn-danger:hover { background: #c0392b; }
    .btn-secondary { background: #95a5a6; color: white; }.btn-secondary:hover { background: #7f8c8d; }
    .btn-warning { background: #f39c12; color: white; }.btn-warning:hover { background: #e67e22; }
    .btn-small { padding: 5px 10px; font-size: 12px; }
    .search-screen { padding: 60px 20px; text-align: center; }
    .search-screen h2 { margin-bottom: 30px; color: #2c3e50; }
    .search-box { max-width: 500px; margin: 0 auto 40px; display: flex; gap: 10px; }
    .search-box input { flex: 1; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; }
    .toolbar { padding: 15px 20px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .toolbar-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
    .content { padding: 20px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
    th { background: #34495e; color: white; font-weight: 600; }
    tr:hover { background: #f8f9fa; }
    .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-draft { background: #ecf0f1; color: #7f8c8d; }
    .status-agreed { background: #d1ecf1; color: #0c5460; }
    .status-in_progress { background: #fff3cd; color: #856404; }
    .status-completed { background: #d4edda; color: #155724; }
    .form-container, .modal-body { max-width: 900px; margin: 0 auto; padding: 20px; }
    .form-group { margin: 15px 0; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-row.full { grid-template-columns: 1fr; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
    .modal.show { display: flex; align-items: start; justify-content: center; padding: 20px; }
    .modal-content { background: white; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center; }
    .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #7f8c8d; }
    .close:hover { color: #2c3e50; }
    .table-form { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .table-form th, .table-form td { padding: 8px; border: 1px solid #ddd; font-size: 13px; }
    .table-form input, .table-form select { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; }
    .table-form input[type="number"] { text-align: right; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
    .error-message { background: #fee; color: #c00; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .success-message { background: #dfd; color: #070; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .account-menu { position: absolute; top: 40px; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; display: none; }
    .account-menu.show { display: block; }
    .account-menu-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
    .account-menu-item:hover { background: #f8f9fa; }
    .account-menu-item:last-child { border-bottom: none; color: #e74c3c; }
    .account-menu-icon { width: 16px; height: 16px; }
    .user-display { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: background 0.2s; }
    .user-display:hover { background: rgba(255,255,255,0.1); }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .user-details { display: flex; flex-direction: column; }
    .user-name { font-weight: 600; font-size: 14px; }
    .user-role { font-size: 11px; color: #bdc3c7; }
    .masked-email { font-family: monospace; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-size: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media print {
      body { background: white !important; padding: 0; }
      .app { box-shadow: none; border-radius: 0; max-width: none; }
      .no-print, .print-hide, .btn { display: none !important; }
      .modal { display: block !important; position: static; background: white; }
      .modal-content { max-height: none; overflow: visible; border: 1px solid #000; }
    }
    .search-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .search-filters input, .search-filters select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .session-timeout { position: fixed; top: 20px; right: 20px; background: #f39c12; color: white; padding: 15px; border-radius: 4px; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>Система управления СТО — ООО «СЕРВИСТРАНСАВТО»</h1>
      <div class="user-info" id="userInfo">
        <div class="account-menu" id="accountMenu">
          <div class="account-menu-item" onclick="showAccountSettings()">
            <svg class="account-menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"></path>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path>
            </svg>
            Настройки аккаунта
          </div>
          <div class="account-menu-item" onclick="changePassword()">
            <svg class="account-menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0110 0v4"></path>
            </svg>
            Сменить пароль
          </div>
          <div class="account-menu-item" onclick="logout()">
            <svg class="account-menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Выйти
          </div>
        </div>
      </div>
    </div>

    <!-- Login -->
    <div id="loginScreen" class="search-screen">
      <h2>Вход в систему</h2>
      <div class="form-container">
        <div id="loginError" class="error-message hide"></div>
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="Введите ваш email" autocomplete="username">
        </div>
        <div class="form-group">
          <label for="loginPassword">Пароль</label>
          <input type="password" id="loginPassword" placeholder="Введите ваш пароль" autocomplete="current-password">
        </div>
        <button id="loginBtn" class="btn btn-primary">Войти</button>
      </div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="hide">
      <div class="toolbar">
        <div class="toolbar-title">Заявки на ремонт</div>
        <div>
          <button id="createClaimBtn" class="btn btn-success">+ Создать заявку</button>
        </div>
      </div>
      <div class="content">
        <!-- Поиск и фильтры -->
        <div class="search-filters">
          <input type="text" id="searchInput" placeholder="Поиск по номеру, госномеру или клиенту..." style="flex: 2;">
          <input type="text" id="searchCarNumber" placeholder="Госномер">
          <select id="filterStatus">
            <option value="">Все статусы</option>
            <option value="draft">Черновик</option>
            <option value="agreed">Согласовано</option>
            <option value="in_progress">В работе</option>
            <option value="completed">Завершена</option>
          </select>
          <button id="searchBtn" class="btn btn-primary">Поиск</button>
          <button id="clearSearchBtn" class="btn btn-secondary">Сбросить</button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Номер</th>
                <th>Дата</th>
                <th>Госномер</th>
                <th>Авто</th>
                <th>Клиент</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Сумма</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="claimsBody"><tr><td colspan="9" style="text-align:center;padding:20px;color:#7f8c8d;">Нет заявок</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Заявка Modal -->
  <div id="claimModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Новая заявка</h2>
        <span class="close" id="closeModalBtn">&times;</span>
      </div>
      <div class="modal-body">
        <form id="claimForm">
          <input type="hidden" id="claimId">
          <input type="hidden" id="claimNumber">

          <!-- Госномер и телефон — на одном уровне -->
          <div class="form-row">
            <div class="form-group">
              <label>Госномер *</label>
              <input type="text" id="carNumber" required pattern="[А-Я]\d{3}[А-Я]{2}\d{2,3}" title="Формат: А123БВ45">
              <small style="color:#666">Формат: А123БВ45 или А123БВ123</small>
            </div>
            <div class="form-group">
              <label>Телефон *</label>
              <input type="tel" id="phone" required pattern="[\d\s\-\+\(\)]{10,}" title="Минимум 10 цифр">
            </div>
          </div>

          <!-- Марка/Модель -->
          <div class="form-row full">
            <div class="form-group">
              <label>Марка/Модель</label>
              <input type="text" list="carBrandList" id="carBrand">
            </div>
          </div>

          <!-- VIN и пробег -->
          <div class="form-row">
            <div class="form-group"><label>VIN</label><input type="text" id="vin"></div>
            <div class="form-group"><label>Пробег (км)</label><input type="number" id="mileage" min="0"></div>
          </div>

          <!-- Клиент -->
          <div class="form-row">
            <div class="form-group"><label>ФИО клиента *</label><input type="text" id="clientFio" required></div>
            <div class="form-group"><label>Компания</label><input type="text" id="clientCompany"></div>
          </div>

          <!-- Описание проблемы -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Описание проблемы</h3>
          <div class="table-container">
            <table class="table-form" id="complaintTable">
              <thead><tr><th>Наименование</th><th>Сторона</th><th>Положение</th><th>Кол-во</th><th></th></tr></thead>
              <tbody id="complaintBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addComplaintBtn">+ Добавить</button>

          <!-- Работы -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Список работ</h3>
          <div class="table-container">
            <table class="table-form" id="worksTable">
              <thead><tr><th>Наименование</th><th>Сторона</th><th>Положение</th><th>Кол-во</th><th class="print-hide">Цена</th><th class="print-hide">Сумма</th><th></th></tr></thead>
              <tbody id="worksBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addWorkBtn">+ Добавить работу</button>

          <!-- Запчасти -->
          <h3 style="margin:25px 0 15px; color:#2c3e50;">Запчасти</h3>
          <div class="table-container">
            <table class="table-form" id="partsTable">
              <thead><tr><th>Артикул</th><th>Наименование</th><th>Сторона</th><th>Положение</th><th>Кол-во</th><th class="print-hide">Цена</th><th class="print-hide">Сумма</th><th></th></tr></thead>
              <tbody id="partsBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-secondary" id="addPartBtn">+ Добавить запчасть</button>

          <!-- Итоги -->
          <div style="display:flex;justify-content:space-between;margin:20px 0;font-weight:bold;">
            <span>Итого работ: <span id="totalWorks">0 ₽</span></span>
            <span>Итого запчастей: <span id="totalParts">0 ₽</span></span>
            <span>Общая сумма: <span id="totalSum">0 ₽</span></span>
          </div>

          <!-- Статус -->
          <div class="form-row full">
            <div class="form-group">
              <label>Статус</label>
              <select id="status">
                <option value="draft">Черновик</option>
                <option value="agreed">Согласовано</option>
                <option value="in_progress">В работе</option>
                <option value="completed">Завершена</option>
              </select>
            </div>
          </div>

          <!-- Кнопки -->
          <div style="margin-top:20px">
            <button type="submit" class="btn btn-success">Сохранить</button>
            <button type="button" class="btn btn-secondary" id="cancelModalBtn">Отмена</button>
            <button type="button" class="btn btn-primary no-print" id="printBtn">Печать</button>
            <button type="button" class="btn btn-danger no-print" id="deleteClaimBtn" style="display:none">Удалить заявку</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Datalists -->
  <datalist id="carBrandList">
    <option value="ГАЗель"><option value="Ford Transit"><option value="Hyundai HD78">
    <option value="Peugeot Boxer"><option value="MAN"><option value="Mercedes-Benz Sprinter">
    <option value="Volkswagen Transporter"><option value="Renault Master"><option value="IVECO Daily">
  </datalist>
  <datalist id="workList">
    <option value="Замена шаровой опоры"><option value="Замена тормозных колодок"><option value="Замена масла">
    <option value="Замена фильтров"><option value="Регулировка развала-схождения"><option value="Диагностика">
    <option value="Замена АКБ"><option value="Замена шин"><option value="Ремонт двигателя">
  </datalist>
  <datalist id="partList">
    <option value="Опора шаровая"><option value="Колодки тормозные"><option value="Масло моторное">
    <option value="Фильтр воздушный"><option value="Фильтр масляный"><option value="Аккумулятор">
    <option value="Шина"><option value="Диск"><option value="Свечи зажигания">
  </datalist>

  <script>
    // Supabase конфигурация
    const SUPABASE_URL = 'https://xvvhranmftqqddbplypu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dmhyYW5tZnRxcWRkYnBseXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Nzk2OTgsImV4cCI6MjA4MTM1NTY5OH0.nAkRjSi5lHIvGwWCfi7GI48A_XRMEtSMKuJS6V3zgi4';
    
    // ВАЖНО: В реальном приложении используйте серверную часть для аутентификации
    // Этот ключ должен быть защищен и не находиться в клиентском коде
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Константы и статусы
    const STATUS_LABELS = {
      draft: 'Черновик',
      agreed: 'Согласовано',
      in_progress: 'В работе',
      completed: 'Завершена'
    };

    const SIDES = ['–', 'Левая', 'Правая', 'Передняя', 'Задняя'];
    const POSITIONS = ['–', 'Верхний', 'Нижний', 'Передний', 'Задний', 'Центр'];

    // Глобальное состояние
    let currentClaims = [];
    let currentUser = null;
    let lastActivity = Date.now();
    let sessionTimeoutId = null;
    const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 минут

    // Вспомогательные функции
    function createSelect(options, value = '') {
      const select = document.createElement('select');
      options.forEach(opt => {
        const el = document.createElement('option');
        el.value = opt === '–' ? '' : opt;
        el.textContent = opt;
        if (el.value === value) el.selected = true;
        select.appendChild(el);
      });
      return select;
    }

    function generateClaimNumber() {
      const now = new Date();
      return `CLAIM-${String(now.getFullYear()).slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount) + ' ₽';
    }

    function showMessage(elementId, message, isError = false) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = isError ? 'error-message' : 'success-message';
      element.classList.remove('hide');
      
      if (!isError) {
        setTimeout(() => element.classList.add('hide'), 3000);
      }
    }

    function maskEmail(email) {
      if (!email) return '';
      const [username, domain] = email.split('@');
      if (!username || !domain) return email;
      
      // Маскируем часть имени пользователя
      const maskedUsername = username.length > 3 
        ? username.substring(0, 3) + '*'.repeat(Math.min(username.length - 3, 4))
        : '*'.repeat(username.length);
      
      return `${maskedUsername}@${domain}`;
    }

    function getUserInitials(name) {
      if (!name) return '?';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    function updateActivity() {
      lastActivity = Date.now();
    }

    function startSessionTimer() {
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      
      sessionTimeoutId = setTimeout(() => {
        const timeSinceLastActivity = Date.now() - lastActivity;
        if (timeSinceLastActivity >= SESSION_TIMEOUT && currentUser) {
          showSessionTimeoutWarning();
        } else {
          startSessionTimer();
        }
      }, 60000); // Проверка каждую минуту
    }

    function showSessionTimeoutWarning() {
      const warningDiv = document.createElement('div');
      warningDiv.className = 'session-timeout';
      warningDiv.innerHTML = `
        <div style="margin-bottom:10px;">Сессия скоро завершится из-за неактивности</div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-primary btn-small" onclick="extendSession()">Продолжить работу</button>
          <button class="btn btn-secondary btn-small" onclick="logout()">Выйти</button>
        </div>
      `;
      document.body.appendChild(warningDiv);
      
      setTimeout(() => {
        if (warningDiv.parentNode) {
          warningDiv.remove();
          if (currentUser) {
            logout();
            alert('Сессия завершена из-за неактивности');
          }
        }
      }, 60000); // Даем 60 секунд на реакцию
    }

    function extendSession() {
      updateActivity();
      const warning = document.querySelector('.session-timeout');
      if (warning) warning.remove();
      startSessionTimer();
    }

    function toggleAccountMenu() {
      const menu = document.getElementById('accountMenu');
      menu.classList.toggle('show');
      
      // Закрываем меню при клике вне его
      if (menu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', closeAccountMenuOnClickOutside);
        }, 0);
      } else {
        document.removeEventListener('click', closeAccountMenuOnClickOutside);
      }
    }

    function closeAccountMenuOnClickOutside(event) {
      const menu = document.getElementById('accountMenu');
      const userInfo = document.getElementById('userInfo');
      
      if (!menu.contains(event.target) && !userInfo.contains(event.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeAccountMenuOnClickOutside);
      }
    }

    function addRow(containerId, data = null, isComplaint = false) {
      const tbody = document.getElementById(containerId);
      const isPart = containerId === 'partsBody';
      const isWork = containerId === 'worksBody';
      const tr = document.createElement('tr');
      
      if (isPart) {
        tr.innerHTML = `
          <td><input type="text" list="partList" placeholder="Артикул" value="${data?.article || ''}"></td>
          <td><input type="text" list="partList" placeholder="Наименование" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          <td class="print-hide"><input type="number" min="0" step="0.01" value="${data?.price || 0}" style="width:80px;"></td>
          <td class="print-hide" style="text-align:right;">${formatCurrency((data?.quantity || 0) * (data?.price || 0))}</td>
          <td class="no-print"><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      } else if (isWork) {
        tr.innerHTML = `
          <td><input type="text" list="workList" placeholder="Наименование" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          <td class="print-hide"><input type="number" min="0" step="0.01" value="${data?.price || 0}" style="width:80px;"></td>
          <td class="print-hide" style="text-align:right;">${formatCurrency((data?.quantity || 0) * (data?.price || 0))}</td>
          <td class="no-print"><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      } else {
        // Complaint
        tr.innerHTML = `
          <td><input type="text" placeholder="Описание проблемы" value="${data?.name || ''}"></td>
          <td></td><td></td>
          <td><input type="number" min="1" value="${data?.quantity || 1}" style="width:60px;"></td>
          <td class="no-print"><button type="button" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">–</button></td>
        `;
      }
      
      // Добавляем селекты для сторон и положений
      const sideCell = isPart ? 2 : isWork ? 1 : 1;
      const positionCell = isPart ? 3 : isWork ? 2 : 2;
      
      tr.querySelectorAll('td')[sideCell].appendChild(createSelect(SIDES, data?.side));
      tr.querySelectorAll('td')[positionCell].appendChild(createSelect(POSITIONS, data?.position));
      
      // Обработчик удаления строки
      const deleteBtn = tr.querySelector('button');
      deleteBtn.onclick = () => {
        if (confirm('Удалить эту запись?')) {
          tr.remove();
          if (isComplaint) syncComplaintToWorks();
          calculateTotals();
        }
      };
      
      // Обработчики для вычислений
      if (!isComplaint) {
        const inputs = tr.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          input.addEventListener('input', calculateTotals);
        });
      }
      
      // Для жалоб - синхронизация с работами
      if (isComplaint) {
        tr.querySelector('input[type="text"]').addEventListener('input', () => syncComplaintToWorks());
        tr.querySelectorAll('select').forEach(select => {
          select.addEventListener('change', () => syncComplaintToWorks());
        });
      }
      
      tbody.appendChild(tr);
      return tr;
    }

    function syncComplaintToWorks() {
      const complaints = [];
      document.querySelectorAll('#complaintBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const name = inputs[0].value;
        if (!name) return;
        
        complaints.push({
          name: name,
          side: inputs[1].value,
          position: inputs[2].value,
          quantity: parseInt(inputs[3].value) || 1
        });
      });
      
      // Сохраняем существующие цены работ
      const priceMap = {};
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const nameInput = tr.querySelector('td:first-child input');
        const priceInput = tr.querySelector('td:nth-child(5) input');
        if (nameInput && nameInput.value && priceInput) {
          priceMap[nameInput.value] = parseFloat(priceInput.value) || 0;
        }
      });
      
      // Обновляем таблицу работ
      const worksBody = document.getElementById('worksBody');
      worksBody.innerHTML = '';
      
      complaints.forEach(complaint => {
        addRow('worksBody', {
          name: complaint.name,
          side: complaint.side,
          position: complaint.position,
          quantity: complaint.quantity,
          price: priceMap[complaint.name] || 0
        });
      });
      
      calculateTotals();
    }

    function calculateTotals() {
      let totalWorks = 0;
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const qty = parseFloat(cells[3].querySelector('input').value) || 0;
        const price = parseFloat(cells[4].querySelector('input').value) || 0;
        const sum = qty * price;
        if (cells[5]) cells[5].textContent = formatCurrency(sum);
        totalWorks += sum;
      });

      let totalParts = 0;
      document.querySelectorAll('#partsBody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const qty = parseFloat(cells[4].querySelector('input').value) || 0;
        const price = parseFloat(cells[5].querySelector('input').value) || 0;
        const sum = qty * price;
        cells[6].textContent = formatCurrency(sum);
        totalParts += sum;
      });

      document.getElementById('totalWorks').textContent = formatCurrency(totalWorks);
      document.getElementById('totalParts').textContent = formatCurrency(totalParts);
      document.getElementById('totalSum').textContent = formatCurrency(totalWorks + totalParts);
    }

    // Основные функции
    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      const errorElement = document.getElementById('loginError');
      
      if (!email || !password) {
        showMessage('loginError', 'Введите email и пароль', true);
        return;
      }
      
      if (!email.includes('@')) {
        showMessage('loginError', 'Введите корректный email', true);
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Вход...';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) throw error;
        
        currentUser = data.user;
        updateActivity();
        startSessionTimer();
        checkUser();
        showMessage('loginError', 'Вход выполнен успешно!', false);
        
      } catch (err) {
        showMessage('loginError', 'Ошибка входа: ' + err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Войти';
      }
    }

    async function logout() {
      if (confirm('Вы уверены, что хотите выйти?')) {
        if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
        await supabase.auth.signOut();
        currentUser = null;
        currentClaims = [];
        checkUser();
      }
    }

    async function checkUser() {
      const { data, error } = await supabase.auth.getUser();
      const ui = {
        login: document.getElementById('loginScreen'),
        main: document.getElementById('mainScreen'),
        user: document.getElementById('userInfo')
      };
      
      if (error || !data?.user) {
        ui.login.classList.remove('hide');
        ui.main.classList.add('hide');
        ui.user.innerHTML = '';
        currentUser = null;
      } else {
        ui.login.classList.add('hide');
        ui.main.classList.remove('hide');
        
        currentUser = data.user;
        updateActivity();
        startSessionTimer();
        
        // Безопасное отображение информации о пользователе
        const maskedEmail = maskEmail(data.user.email);
        const userName = data.user.user_metadata?.full_name || data.user.email.split('@')[0];
        const initials = getUserInitials(userName);
        
        ui.user.innerHTML = `
          <div class="user-display" onclick="toggleAccountMenu()">
            <div class="user-avatar">${initials}</div>
            <div class="user-details">
              <div class="user-name">${userName}</div>
              <div class="user-role">Сотрудник СТО</div>
            </div>
          </div>
          <div class="account-menu" id="accountMenu">
            <div class="account-menu-item" onclick="showAccountSettings()">
              <svg class="account-menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"></path>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path>
              </svg>
              Настройки аккаунта
            </div>
            <div class="account-menu-item" onclick="changePassword()">
              <svg class="account-menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0110 0v4"></path>
              </svg>
              Сменить пароль
            </div>
            <div class="account-menu-item" onclick="logout()">
              <svg class="account-menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Выйти
            </div>
          </div>
        `;
        
        loadClaims();
      }
    }

    async function loadClaims(filters = {}) {
      const body = document.getElementById('claimsBody');
      body.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:#7f8c8d;">Загрузка...</td></tr>';
      
      try {
        let query = supabase
          .from('claims')
          .select('*')
          .order('created_at', { ascending: false });
        
        // Применяем фильтры
        if (filters.search) {
          query = query.or(`number.ilike.%${filters.search}%,car_number.ilike.%${filters.search}%,client_fio.ilike.%${filters.search}%`);
        }
        
        if (filters.carNumber) {
          query = query.ilike('car_number', `%${filters.carNumber}%`);
        }
        
        if (filters.status) {
          query = query.eq('status', filters.status);
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        currentClaims = data || [];
        renderClaimsTable(currentClaims);
        
      } catch (error) {
        body.innerHTML = `<tr><td colspan="9" style="text-align:center;color:#e74c3c;padding:20px;">Ошибка: ${error.message}</td></tr>`;
      }
    }

    function renderClaimsTable(claims) {
      const body = document.getElementById('claimsBody');
      
      if (!claims || claims.length === 0) {
        body.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#7f8c8d;padding:20px;">Нет заявок</td></tr>';
        return;
      }
      
      body.innerHTML = claims.map(claim => {
        // Вычисляем общую сумму
        const worksTotal = (claim.works || []).reduce((sum, work) => sum + (work.quantity * work.price), 0);
        const partsTotal = (claim.parts || []).reduce((sum, part) => sum + (part.quantity * part.price), 0);
        const totalAmount = worksTotal + partsTotal;
        
        return `
          <tr>
            <td>${claim.number || 'N/A'}</td>
            <td>${new Date(claim.created_at).toLocaleDateString('ru-RU')}</td>
            <td>${claim.car_number || '-'}</td>
            <td>${claim.car_brand || '-'}</td>
            <td>${claim.client_fio || '-'}</td>
            <td>${claim.phone || '-'}</td>
            <td><span class="status status-${claim.status}">${STATUS_LABELS[claim.status] || claim.status}</span></td>
            <td>${formatCurrency(totalAmount)}</td>
            <td>
              <button class="btn btn-secondary" onclick="editClaim('${claim.id}')">Редактировать</button>
              <button class="btn btn-primary" onclick="printClaimById('${claim.id}')">Печать</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function searchClaims() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      const carNumber = document.getElementById('searchCarNumber').value.trim();
      const status = document.getElementById('filterStatus').value;
      
      loadClaims({
        search: searchTerm,
        carNumber: carNumber,
        status: status
      });
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchCarNumber').value = '';
      document.getElementById('filterStatus').value = '';
      loadClaims();
    }

    function showClaimForm(claim = null) {
      const isEdit = !!claim;
      
      document.getElementById('claimId').value = isEdit ? claim.id : '';
      document.getElementById('claimNumber').value = isEdit ? claim.number : generateClaimNumber();
      document.getElementById('modalTitle').textContent = isEdit ? 'Редактирование заявки' : 'Новая заявка';
      
      // Очистка формы
      const form = document.getElementById('claimForm');
      form.reset();
      
      // Заполнение основных полей
      if (isEdit) {
        document.getElementById('carNumber').value = claim.car_number || '';
        document.getElementById('carBrand').value = claim.car_brand || '';
        document.getElementById('vin').value = claim.vin || '';
        document.getElementById('mileage').value = claim.mileage || '';
        document.getElementById('clientFio').value = claim.client_fio || '';
        document.getElementById('clientCompany').value = claim.client_company || '';
        document.getElementById('phone').value = claim.phone || '';
        document.getElementById('status').value = claim.status || 'draft';
        
        // Очистка таблиц
        document.getElementById('complaintBody').innerHTML = '';
        document.getElementById('worksBody').innerHTML = '';
        document.getElementById('partsBody').innerHTML = '';
        
        // Заполнение таблиц
        (claim.complaint || []).forEach(item => addRow('complaintBody', item, true));
        (claim.works || []).forEach(item => addRow('worksBody', item, false));
        (claim.parts || []).forEach(item => addRow('partsBody', item, false));
        
        // Показываем кнопку удаления
        document.getElementById('deleteClaimBtn').style.display = 'inline-block';
      } else {
        // Новая заявка
        document.getElementById('status').value = 'draft';
        document.getElementById('complaintBody').innerHTML = '';
        document.getElementById('worksBody').innerHTML = '';
        document.getElementById('partsBody').innerHTML = '';
        
        // Добавляем начальные строки
        addRow('complaintBody', null, true);
        addRow('partsBody', null, false);
        
        // Скрываем кнопку удаления
        document.getElementById('deleteClaimBtn').style.display = 'none';
      }
      
      calculateTotals();
      document.getElementById('claimModal').classList.add('show');
    }

    async function saveClaim(e) {
      e.preventDefault();
      
      if (!currentUser) {
        alert('Сначала войдите в систему');
        return;
      }
      
      // Валидация
      const carNumber = document.getElementById('carNumber').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const clientFio = document.getElementById('clientFio').value.trim();
      
      if (!carNumber || !phone || !clientFio) {
        alert('Заполните обязательные поля: Госномер, Телефон и ФИО клиента');
        return;
      }
      
      // Сбор данных из таблиц
      const complaint = [], works = [], parts = [];
      
      document.querySelectorAll('#complaintBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const name = inputs[0].value.trim();
        if (name) {
          complaint.push({
            name: name,
            side: inputs[1].value,
            position: inputs[2].value,
            quantity: parseInt(inputs[3].value) || 1
          });
        }
      });
      
      document.querySelectorAll('#worksBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const name = inputs[0].value.trim();
        if (name) {
          works.push({
            name: name,
            side: inputs[1].value,
            position: inputs[2].value,
            quantity: parseInt(inputs[3].value) || 1,
            price: parseFloat(inputs[4].value) || 0
          });
        }
      });
      
      document.querySelectorAll('#partsBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input, select');
        const article = inputs[0].value.trim();
        const name = inputs[1].value.trim();
        if (name || article) {
          parts.push({
            article: article,
            name: name,
            side: inputs[2].value,
            position: inputs[3].value,
            quantity: parseInt(inputs[4].value) || 1,
            price: parseFloat(inputs[5].value) || 0
          });
        }
      });
      
      const claimData = {
        car_number: carNumber,
        car_brand: document.getElementById('carBrand').value.trim(),
        vin: document.getElementById('vin').value.trim(),
        mileage: parseInt(document.getElementById('mileage').value) || null,
        client_fio: clientFio,
        client_company: document.getElementById('clientCompany').value.trim(),
        phone: phone,
        complaint: complaint,
        works: works,
        parts: parts,
        status: document.getElementById('status').value,
        number: document.getElementById('claimNumber').value,
        user_id: currentUser.id
      };
      
      try {
        const claimId = document.getElementById('claimId').value;
        let result;
        
        if (claimId) {
          // Обновление существующей заявки
          result = await supabase
            .from('claims')
            .update(claimData)
            .eq('id', claimId);
        } else {
          // Создание новой заявки
          result = await supabase
            .from('claims')
            .insert([claimData]);
        }
        
        const { error } = result;
        
        if (error) throw error;
        
        alert('Заявка успешно сохранена!');
        closeModal();
        loadClaims();
        
      } catch (error) {
        alert('Ошибка сохранения: ' + error.message);
      }
    }

    async function editClaim(id) {
      try {
        const { data, error } = await supabase
          .from('claims')
          .select('*')
          .eq('id', id)
          .single();
        
        if (error) throw error;
        
        showClaimForm(data);
        
      } catch (error) {
        alert('Ошибка загрузки заявки: ' + error.message);
      }
    }

    async function deleteClaim() {
      const claimId = document.getElementById('claimId').value;
      
      if (!claimId) return;
      
      if (confirm('Вы уверены, что хотите удалить эту заявку? Это действие нельзя отменить.')) {
        try {
          const { error } = await supabase
            .from('claims')
            .delete()
            .eq('id', claimId);
          
          if (error) throw error;
          
          alert('Заявка удалена!');
          closeModal();
          loadClaims();
          
        } catch (error) {
          alert('Ошибка удаления: ' + error.message);
        }
      }
    }

    function printClaimById(id) {
      const claim = currentClaims.find(c => c.id === id);
      if (!claim) return;
      
      // Создаем временную форму для печати
      showClaimForm(claim);
      setTimeout(() => {
        window.print();
      }, 100);
    }

    function closeModal() {
      document.getElementById('claimModal').classList.remove('show');
    }

    function showAccountSettings() {
      alert('Настройки аккаунта будут доступны в следующей версии');
      document.getElementById('accountMenu').classList.remove('show');
    }

    function changePassword() {
      alert('Смена пароля будет доступна в следующей версии');
      document.getElementById('accountMenu').classList.remove('show');
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
      // Кнопки
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('createClaimBtn').addEventListener('click', () => showClaimForm());
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
      document.getElementById('printBtn').addEventListener('click', () => window.print());
      document.getElementById('deleteClaimBtn').addEventListener('click', deleteClaim);
      
      // Добавление строк в таблицы
      document.getElementById('addComplaintBtn').addEventListener('click', () => addRow('complaintBody', null, true));
      document.getElementById('addWorkBtn').addEventListener('click', () => addRow('worksBody', null, false));
      document.getElementById('addPartBtn').addEventListener('click', () => addRow('partsBody', null, false));
      
      // Поиск
      document.getElementById('searchBtn').addEventListener('click', searchClaims);
      document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
      
      // Поиск по Enter
      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchClaims();
      });
      
      // Форма
      document.getElementById('claimForm').addEventListener('submit', saveClaim);
      
      // Закрытие модалки
      document.getElementById('claimModal').addEventListener('click', (e) => {
        if (e.target.id === 'claimModal') closeModal();
      });
      
      // Автовход по Enter на форме входа
      document.getElementById('loginPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
      });
      
      // Отслеживание активности пользователя
      document.addEventListener('click', updateActivity);
      document.addEventListener('keypress', updateActivity);
      document.addEventListener('mousemove', updateActivity);
      document.addEventListener('scroll', updateActivity);
      
      // Проверка пользователя при загрузке
      checkUser();
    });
  </script>
</body>
</html>
