<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f8f9fa; padding: 20px; }
    .container { max-width: 960px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .auth-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .auth-form { background: white; padding: 30px; border-radius: 8px; width: 350px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .auth-form h2 { margin-bottom: 20px; text-align: center; }
    .auth-form input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .auth-form button { width: 100%; padding: 12px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 15px; font-weight: bold; }
    .auth-form button:hover { background: #0056b3; }
    .auth-info { font-size: 12px; margin-top: 15px; color: #666; line-height: 1.5; }
    .user-info { position: fixed; top: 20px; right: 20px; background: white; padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; z-index: 999; }
    .user-info button { margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .hidden { display: none; }
    .error { color: #dc3545; font-size: 14px; margin-top: 10px; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; }
    .success { color: #155724; font-size: 14px; margin-top: 10px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; }
    h1 { text-align: center; margin-bottom: 20px; color: #333; }
    .form-group { margin: 15px 0; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #444; }
    .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
    .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; margin: 5px; }
    .btn:hover { background: #0056b3; }
  </style>
</head>
<body>

<div id="auth-overlay" class="auth-overlay">
  <div class="auth-form">
    <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
    <input type="email" id="email-input" placeholder="Email" required>
    <input type="password" id="password-input" placeholder="–ü–∞—Ä–æ–ª—å" required>
    <button id="login-button">–í–æ–π—Ç–∏</button>
    <div id="auth-error" class="error hidden"></div>
    <div class="auth-info">
      üí° –í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.<br>
      ‚ö†Ô∏è –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
    </div>
  </div>
</div>

<div id="user-info" class="user-info hidden">
  <span id="user-email"></span>
  <button id="logout-button">–í—ã—Ö–æ–¥</button>
</div>

<div class="container hidden" id="main-app">
  <h1>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</h1>
  
  <div class="form-group">
    <label>–ì–æ—Å–Ω–æ–º–µ—Ä *</label>
    <input type="text" id="car-number" placeholder="–ê123–ë–í77" required>
  </div>
  
  <div class="form-group">
    <label>–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ *</label>
    <input type="text" id="client-fio" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò." required>
  </div>
  
  <div class="form-group">
    <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
    <input type="tel" id="phone" placeholder="+7 (999) 999-99-99" required>
  </div>
  
  <div class="form-group">
    <label>–ñ–∞–ª–æ–±–∞ –∫–ª–∏–µ–Ω—Ç–∞ *</label>
    <textarea id="complaint" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..." required></textarea>
  </div>
  
  <button class="btn" id="save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
  <div id="save-message" class="hidden"></div>
</div>

<script>
  // ========== SUPABASE CONFIGURATION ==========
  const SUPABASE_URL = 'https://xvvhranmftqqddbplypu.supabase.co';
    const SUPABASE_ANON_KEY = '      eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dmhyYW5tZnRxcWRkYnBseXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Nzk2OTgsImV4cCI6MjA4MTM1NTY5OH0.nAkRjSi5lHIvGwWCfi7GI48A_XRMEtSMKuJS6V3zgi4';
  
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  
  // ========== DOM ELEMENTS ==========
  const authOverlay = document.getElementById('auth-overlay');
  const emailInput = document.getElementById('email-input');
  const passwordInput = document.getElementById('password-input');
  const loginButton = document.getElementById('login-button');
  const authError = document.getElementById('auth-error');
  const userInfo = document.getElementById('user-info');
  const userEmail = document.getElementById('user-email');
  const logoutButton = document.getElementById('logout-button');
  const mainApp = document.getElementById('main-app');
  const saveButton = document.getElementById('save-button');
  const saveMessage = document.getElementById('save-message');
  
  // ========== INITIALIZE ==========
  async function init() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    
    if (session?.user) {
      currentUser = session.user;
      showMainApp();
    } else {
      showAuthOverlay();
    }
  }
  
  // ========== AUTH FUNCTIONS ==========
  async function handleLogin() {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    
    if (!email || !password) {
      showError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
      return;
    }
    
    loginButton.disabled = true;
    loginButton.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    hideError();
    
    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) throw error;
      
      currentUser = data.user;
      showMainApp();
    } catch (error) {
      console.error('Login error:', error);
      showError('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
    } finally {
      loginButton.disabled = false;
      loginButton.textContent = '–í–æ–π—Ç–∏';
    }
  }
  
  async function handleLogout() {
    await supabaseClient.auth.signOut();
    currentUser = null;
    showAuthOverlay();
  }
  
  function showAuthOverlay() {
    authOverlay.classList.remove('hidden');
    mainApp.classList.add('hidden');
    userInfo.classList.add('hidden');
  }
  
  function showMainApp() {
    authOverlay.classList.add('hidden');
    mainApp.classList.remove('hidden');
    userInfo.classList.remove('hidden');
    userEmail.textContent = currentUser.email;
  }
  
  function showError(message) {
    authError.textContent = message;
    authError.classList.remove('hidden');
  }
  
  function hideError() {
    authError.classList.add('hidden');
  }
  
  // ========== SAVE CLAIM ==========
  async function handleSave() {
    const carNumber = document.getElementById('car-number').value.trim();
    const clientFio = document.getElementById('client-fio').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const complaint = document.getElementById('complaint').value.trim();
    
    if (!carNumber || !clientFio || !phone || !complaint) {
      showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
      return;
    }
    
    saveButton.disabled = true;
    saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    try {
      const { data, error } = await supabaseClient
        .from('claims')
        .insert({
          car_number: carNumber,
          client_fio: clientFio,
          phone: phone,
          complaint: complaint,
          master_id: currentUser.id,
          status: 'draft'
        })
        .select()
        .single();
      
      if (error) throw error;
      
      showMessage('–ó–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
      clearForm();
    } catch (error) {
      console.error('Save error:', error);
      showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
    } finally {
      saveButton.disabled = false;
      saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É';
    }
  }
  
  function showMessage(message, type) {
    saveMessage.textContent = message;
    saveMessage.className = type;
    saveMessage.classList.remove('hidden');
    setTimeout(() => saveMessage.classList.add('hidden'), 5000);
  }
  
  function clearForm() {
    document.getElementById('car-number').value = '';
    document.getElementById('client-fio').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('complaint').value = '';
  }
  
  // ========== EVENT LISTENERS ==========
  loginButton.addEventListener('click', handleLogin);
  logoutButton.addEventListener('click', handleLogout);
  saveButton.addEventListener('click', handleSave);
  
  passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });
  
  // ========== START APP ==========
  init();
</script>

</body>
</html>
