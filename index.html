<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Система управления СТО</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial, sans-serif; margin: 0; background:#f5f6f8; }
header { background:#2c3e50; color:#fff; padding:15px; }
.container { padding:20px; }
.hidden { display:none; }
input, button { padding:8px; margin:5px 0; width:100%; }
button { background:#3498db; color:#fff; border:none; cursor:pointer; }
button:hover { background:#2980b9; }
.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  display:none; justify-content:center; align-items:center;
}
.modal.show { display:flex; }
.modal-content {
  background:#fff; padding:20px; width:400px;
}
</style>
</head>

<body>

<header>
  <h2>Система управления СТО — ООО «СЕРВИСТРАНСАВТО»</h2>
</header>

<div class="container">

  <!-- LOGIN -->
  <div id="loginScreen">
    <h3>Вход в систему</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Пароль">
    <button id="loginBtn">Войти</button>
  </div>

  <!-- MAIN -->
  <div id="mainScreen" class="hidden">
    <button id="logoutBtn">Выйти</button>
    <button id="createClaimBtn">Создать заявку</button>
    <div id="claimsList"></div>
  </div>

</div>

<!-- MODAL -->
<div id="claimModal" class="modal">
  <div class="modal-content">
    <h3>Новая заявка</h3>
    <input id="car" placeholder="Автомобиль">
    <input id="problem" placeholder="Неисправность">
    <button id="saveClaimBtn">Сохранить</button>
    <button id="cancelModalBtn">Отмена</button>
  </div>
</div>

<script>
/* ================== SUPABASE ================== */

const SUPABASE_URL = 'https://xvvhranmftqqddbplypu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dmhyYW5tZnRxcWRkYnBseXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3Nzk2OTgsImV4cCI6MjA4MTM1NTY5OH0.nAkRjSi5lHIvGwWCfi7GI48A_XRMEtSMKuJS6V3zgi4';

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================== SCREENS ================== */

const loginScreen = document.getElementById('loginScreen');
const mainScreen  = document.getElementById('mainScreen');
const claimModal  = document.getElementById('claimModal');

/* ================== AUTH ================== */

async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert(error.message);
  } else {
    showMainScreen();
  }
}

async function logout() {
  await supabaseClient.auth.signOut();
  showLoginScreen();
}

async function checkUser() {
  const { data } = await supabaseClient.auth.getUser();
  if (data?.user) {
    showMainScreen();
  } else {
    showLoginScreen();
  }
}

/* ================== UI ================== */

function showLoginScreen() {
  loginScreen.classList.remove('hidden');
  mainScreen.classList.add('hidden');
}

function showMainScreen() {
  loginScreen.classList.add('hidden');
  mainScreen.classList.remove('hidden');
  loadClaims();
}

function showClaimForm() {
  claimModal.classList.add('show');
}

function closeModal() {
  claimModal.classList.remove('show');
}

/* ================== CLAIMS ================== */

async function saveClaim() {
  const car = document.getElementById('car').value;
  const problem = document.getElementById('problem').value;

  const { data, error: userError } = await supabaseClient.auth.getUser();
  const user = data?.user;

  if (userError || !user) {
    alert('Сначала войдите в систему');
    return;
  }

  const { error } = await supabaseClient
    .from('claims')
    .insert({
      car,
      problem,
      user_id: user.id
    });

  if (error) {
    alert(error.message);
  } else {
    closeModal();
    loadClaims();
  }
}

async function loadClaims() {
  const { data, error } = await supabaseClient
    .from('claims')
    .select('*')
    .order('id', { ascending:false });

  if (error) return;

  const list = document.getElementById('claimsList');
  list.innerHTML = '';

  data.forEach(c => {
    const div = document.createElement('div');
    div.textContent = `${c.car} — ${c.problem}`;
    list.appendChild(div);
  });
}

/* ================== EVENTS ================== */

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('logoutBtn').addEventListener('click', logout);
  document.getElementById('createClaimBtn').addEventListener('click', showClaimForm);
  document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
  document.getElementById('saveClaimBtn').addEventListener('click', saveClaim);
  checkUser();
});
</script>

</body>
</html>
